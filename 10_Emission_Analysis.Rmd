---
title: "10_Emission_Analysis"
output: html_document
date: "2025-09-26"
---
## 18) Link emissions to productivity data 

here we will have the same issue as with feed intake data since the Alevel in the data tab dont always latch the ones in the diet tab 

```{r}
library(dplyr)
library(ERAg)
library(stringr)
library(knitr)
library(dplyr)
library(DT)
library(readxl)
library(tidyr)
library(arrow)
library(ggplot2)
library(data.table)
library(purrr)
library(janitor)
library(ggalt)
library(dplyr)
library(ggplot2)
library(readr)
library(stringr)
library(forcats)

GE_combined      <- read.csv("~/Emission_Analysis/data/GE_combined.csv")          
yield_data       <- read.csv("~/Emission_Analysis/data/yield_data.csv")
weights_unique   <- read.csv("~/Emission_Analysis/data/weights_unique.csv")
practice_tbl     <- read.csv("~/Emission_Analysis/data/practice_tbl.csv")
merged_metadata <- readRDS("~/Emission_Analysis/data/merged_metadata_nutrition_inference.rds")
classif_ing_simple <- read.csv("~/Emission_Analysis/data/classif_ing_simple.csv")
diet_percentages <- read.csv("~/Emission_Analysis/data/diet_percentages_classif.csv")


roman_to_name <- function(x) dplyr::recode(
  x,
  "I"   = "High-starch",
  "II"  = "High-fat",
  "III" = "Protein",
  "IV"  = "Good forage",
  "V"   = "Poor forage",
  "VI"  = "Mineral/Vitamin",
  .default = x,
  .missing = NA_character_
)

# Update the ingredient database
classif_ing_simple <- classif_ing_simple %>%
  dplyr::mutate(
    Ingredient_Category = roman_to_name(Ingredient_Category))
    # If you also keep a diet-level tag, uncomment:
    # , Diet_Category = roman_to_name(Diet_Category)
  

```


### to be removed papers with problems 

```{r}
#EM1047 too high intake not possible 

GE_combined<-GE_combined %>%
  filter(B.Code!="EM1047")

#BO1076 loo at practice tbl becaus esays no change but ther eis 

```


### 18.1) Merge yield and emission data and number of papers 

```{r}

# Step 1: Make sure the key columns match (D.Item and A.Level.Name)
GE_combined_for_merge <- GE_combined %>%
  filter(!is.na(CH4_kg_year))%>%
  rename(A.Level.Name = D.Item)%>%
  select(-"ED.Mean.T")


yield_data <- yield_data %>%
  filter(!is.na(ED.Mean.T))


# Step 2: Merge yield and emission data
yield_with_emissions <- GE_combined_for_merge %>%
  left_join(
    yield_data,
    by = c("B.Code", "A.Level.Name")
  )%>%
    filter(!is.na(ED.Mean.T))%>%
  filter(!is.na(CH4_kg_year))

  

# distinct B.Code per product
bcode_per_product <- yield_with_emissions %>%          # or yield_data
  distinct(P.Product, B.Code) %>%                      # keep one row per pair
  count(P.Product, name = "n_BCodes")                  # tally them

bcode_per_product

practice_tbl<-practice_tbl%>%
  filter(B.Code %in% yield_with_emissions$B.Code)

length(unique(practice_tbl$B.Code))

```


primary data exploration
```{r}
# ─────────────────────────────────────────────────────────────
# Libraries
# ─────────────────────────────────────────────────────────────
# ─────────────────────────────────────────────────────────────
# Clean and merge: diet_percentages + ingredient classification
# ─────────────────────────────────────────────────────────────
diet_percentages <- diet_percentages %>%
  mutate(D.Item_clean = tolower(str_trim(D.Item)))

classif_ing_simple <- classif_ing_simple %>%
  mutate(D.Item_clean = tolower(str_trim(D.Item)))

diet_pct_classif <- diet_percentages %>%
  left_join(classif_ing_simple %>% select(D.Item_clean, Ingredient_Category),
            by = "D.Item_clean") %>%
  filter(!is.na(Ingredient_Category))

# ─────────────────────────────────────────────────────────────
# FIGURE 1: Barplot of Contribution by Ingredient Category
# ─────────────────────────────────────────────────────────────
diet_pct_classif %>%
  group_by(Ingredient_Category) %>%
  summarise(TotalPct = sum(Percentage_of_Diet, na.rm = TRUE)) %>%
  ggplot(aes(x = reorder(Ingredient_Category, TotalPct), y = TotalPct)) +
  geom_col(fill = "forestgreen") +
  coord_flip() +
  labs(
    title = "Contribution of Ingredient Categories to Livestock Diets",
    x = "Ingredient Category",
    y = "Cumulative Share of Diet (%)"
  ) +
  theme_minimal()


# Compute count of unique B.Code per Practice
practice_counts <- practice_tbl %>%
  filter(Practice %in% c("Addition", "Substitution", "No change")) %>%
  group_by(Practice) %>%
  summarise(N_cases = n_distinct(B.Code)) %>%
  ungroup()

# Join back to the main table for labeling inside each facet
practice_labeled <- practice_tbl %>%
  filter(Practice %in% c("Addition", "Substitution", "No change")) %>%
  left_join(practice_counts, by = "Practice")

# Base plot with counts annotated in facet titles
ggplot(practice_labeled, aes(x = Magnitude_pct, fill = Practice)) +
  geom_histogram(binwidth = 2, color = "white") +
  facet_wrap(~ Practice + N_cases, scales = "free_y",
             labeller = labeller(.cols = function(practice) {
               paste0(practice, "\n(n = ", practice_counts$N_cases[match(practice, practice_counts$Practice)], ")")
             })) +
  labs(
    title = "Magnitude of Diet Change by Practice Type",
    x = "Change in % of Diet",
    y = "Number of Cases",
    fill = "Practice"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    strip.text = element_text(face = "bold", size = 12),
    legend.position = "none"
  )


# ─────────────────────────────────────────────────────────────
# FIGURE 3: Top Substitution Pairs
# ─────────────────────────────────────────────────────────────
practice_tbl %>%
  filter(Practice == "Substitution", Substitution_pairs != "") %>%
  count(Substitution_pairs, sort = TRUE) %>%
  slice_head(n = 10) %>%
  ggplot(aes(x = reorder(Substitution_pairs, n), y = n)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  labs(
    title = "Top 10 Substitution Category Pairs",
    x = "From → To",
    y = "Frequency"
  ) +
  theme_minimal()

# ─────────────────────────────────────────────────────────────
# FIGURE 4: GE vs CH4 Emissions
# ─────────────────────────────────────────────────────────────
GE_combined %>%
  filter(!is.na(CH4_kg_year), !is.na(GE_daily)) %>%
  ggplot(aes(x = GE_daily, y = CH4_kg_year)) +
  geom_point(alpha = 0.6, color = "gray30") +
  geom_smooth(method = "lm", se = FALSE, color = "firebrick") +
  labs(
    title = "Methane Emissions vs Gross Energy Intake",
    x = "Gross Energy (MJ/day)",
    y = "Methane (kg CH₄ / year)"
  ) +
  theme_minimal()



```
## Emission in function of the highest cat in each diet 

```{r}
emission_ing_classif<-diet_pct_classif%>%
  left_join(GE_combined_for_merge,by=c("B.Code","A.Level.Name"))%>%
  filter(!is.na(CH4_kg_year))

#number of unique codes 
emission_ing_classif %>%
  group_by(P.Product) %>%
  summarise(n_unique_B = n_distinct(B.Code), .groups = "drop") %>%
  arrange(desc(n_unique_B))

```


```{r}


df <- emission_ing_classif

# 1) Dominant ingredient per diet (max % of diet), keep Product
dom <- df %>%
  group_by(A.Level.Name) %>%
  slice_max(Percentage_of_Diet, n = 1, with_ties = FALSE) %>%
  ungroup() %>%
  select(A.Level.Name, P.Product, dom_category = Ingredient_Category)

# 2) One CH4 value per diet
ch4 <- df %>%
  group_by(A.Level.Name) %>%
  summarise(CH4_kg_year = mean(CH4_kg_year, na.rm = TRUE), .groups = "drop")

# 3) Join and summarise BY PRODUCT × DOMINANT INGREDIENT
summary_by_prod_dom <- dom %>%
  left_join(ch4, by = "A.Level.Name") %>%
  group_by(P.Product, dom_category) %>%
  summarise(
    n_diets    = n(),
    mean_CH4   = mean(CH4_kg_year, na.rm = TRUE),
    median_CH4 = median(CH4_kg_year, na.rm = TRUE),
    sd_CH4     = sd(CH4_kg_year, na.rm = TRUE),
    .groups = "drop_last"
  ) %>%
  arrange(P.Product, desc(n_diets))

summary_by_prod_dom

```

```{r}
plot_df <- dom %>%
  left_join(ch4, by = "A.Level.Name") %>%
  filter(CH4_kg_year < 100)   # optional outlier trim; remove if not desired
# get common y-limits across all products (after any filtering you apply)
y_lims <- range(plot_df$CH4_kg_year, na.rm = TRUE)

ggplot(plot_df, aes(x = dom_category, y = CH4_kg_year, fill = dom_category)) +
  geom_boxplot(alpha = 0.6, outlier.alpha = 0.5) +
  geom_jitter(width = 0.15, height = 0, alpha = 0.5, size = 1.4, show.legend = FALSE) +
  facet_wrap(~ P.Product, scales = "fixed") +              # <- same y for all facets
  scale_y_continuous(limits = y_lims, expand = expansion(mult = c(0.02, 0.05))) +
  labs(x = NULL, y = "CH₄ (kg / animal / year)",
       title = "Enteric CH₄ by dominant ingredient category within each product") +
  theme_minimal(base_size = 12) +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 25, hjust = 1))



```

```{r}
suppressPackageStartupMessages({
  library(dplyr); library(stringr); library(tidyr); library(forcats); library(ggplot2)
})

# ---------- helpers ----------
str_clean <- function(x) stringr::str_squish(as.character(x))
has <- function(x, pat) stringr::str_detect(stringr::str_to_lower(coalesce(x, "")),
                                            stringr::str_to_lower(pat))
first_non_na <- function(x){ x <- x[!is.na(x)]; if (length(x)==0) NA else x[1] }

# ---------- 1) CH4 per arm + species from emissions ----------
em_dat <- emission_ing_classif %>%
  mutate(B.Code = str_clean(B.Code), A.Level.Name = str_clean(A.Level.Name)) %>%
  group_by(B.Code, A.Level.Name) %>%
  summarise(
    CH4_kg_year = mean(CH4_kg_year, na.rm = TRUE),
    P.Product   = dplyr::first(na.omit(P.Product)),
    .groups = "drop"
  )

# ---------- 2) Practice/Subpractice map (include controls) ----------
practice_tbl <- practice_tbl %>%
  mutate(B.Code = str_clean(B.Code), Control = str_clean(Control), Trt = str_clean(Trt))

map_trt <- practice_tbl %>%
  transmute(B.Code, A.Level.Name = Trt, Practice, Subpractice, Magnitude_pct)

map_ctrl <- practice_tbl %>%
  distinct(B.Code, A.Level.Name = Control) %>%
  mutate(Practice="Control", Subpractice="", Magnitude_pct = 0)

practice_map <- bind_rows(map_trt, map_ctrl) %>%
  distinct(B.Code, A.Level.Name, .keep_all = TRUE) %>%
  # ---- collapse multi-category Additions into "Mixed" ----
  mutate(Subpractice = if_else(Practice=="Addition" & str_detect(Subpractice, ","),
                               "Mixed", Subpractice))

# ---------- 3) Choose one yield per arm ----------
yld <- yield_with_emissions %>%
  mutate(B.Code = str_clean(B.Code), A.Level.Name = str_clean(A.Level.Name)) %>%
  group_by(B.Code, A.Level.Name) %>%
  mutate(is_yield = str_detect(str_to_lower(coalesce(Out.Subind, "")), "yield")) %>%
  arrange(B.Code, A.Level.Name, desc(is_yield), desc(!is.na(ED.Mean.T))) %>%
  summarise(
    Yield   = first_non_na(ED.Mean.T),
    Product = first_non_na(Out.Subind),
    Units   = first_non_na(Out.Unit),
    .groups = "drop"
  )

# ---------- 4) Final joined table (keeps controls) ----------
final_df <- em_dat %>%
  left_join(practice_map, by = c("B.Code", "A.Level.Name")) %>%
  left_join(yld,         by = c("B.Code", "A.Level.Name")) %>%
  transmute(
    B.Code, A.Level.Name,
    Practice    = coalesce(Practice, "Unknown"),
    Subpractice = coalesce(Subpractice, ""),
    Magnitude_pct,
    CH4_kg_year,
    Yield, Product, Units,
    P.Product
  ) %>%
  filter(Practice != "Unknown") %>%
  drop_na(CH4_kg_year, Yield, Units, P.Product) %>%
  arrange(B.Code, A.Level.Name)%>%
  filter(Practice!="No change")

```

```{r}
# ---------- 5) Compute EI (g CH4 / kg product) ----------
final_with_ei_all <- final_df %>%
  mutate(
    days_per_year = case_when(
      has(Units, "/day")  ~ 365,
      has(Units, "/year") ~ 1,
      TRUE ~ NA_real_
    ),
    yield_kg = case_when(
      has(Units, "kg") ~ Yield,
      has(Units, "g")  ~ Yield/1000,
      has(Units, "l") & has(Product, "milk") ~ Yield * 1.03,  # L→kg for milk
      TRUE ~ NA_real_
    ),
    annual_yield_kg = yield_kg * days_per_year,
    EI_g_per_kg     = (CH4_kg_year * 1000) / annual_yield_kg
  ) %>%
  filter(is.finite(EI_g_per_kg), EI_g_per_kg > 0, is.finite(annual_yield_kg))

# ---------- 6) Deltas vs control (treatment–control within B.Code) ----------
ctrl_map <- practice_tbl %>% distinct(B.Code, Control) %>% rename(Control_Arm = Control)

ctrl_metrics <- final_with_ei_all %>%
  select(B.Code, A.Level.Name, EI_ctrl = EI_g_per_kg,
         CH4_ctrl = CH4_kg_year, Y_ctrl = annual_yield_kg) %>%
  rename(Control_Arm = A.Level.Name)

final_with_deltas <- practice_tbl %>%
  select(B.Code, Control_Arm = Control, A.Level.Name = Trt, Practice, Subpractice, Magnitude_pct) %>%
  # align "Mixed" rule for Additions here too
  mutate(Subpractice = if_else(Practice=="Addition" & str_detect(Subpractice, ","),
                               "Mixed", Subpractice)) %>%
  inner_join(final_with_ei_all, by = c("B.Code","A.Level.Name")) %>%
  inner_join(ctrl_metrics,      by = c("B.Code","Control_Arm")) %>%
  mutate(
    Delta_EI_pct       = 100 * (EI_g_per_kg / EI_ctrl - 1),
    Delta_EI_g_per_kg  = EI_g_per_kg - EI_ctrl,
    Delta_CH4_pct      = 100 * (CH4_kg_year / CH4_ctrl - 1),
    Delta_Y_pct        = 100 * (annual_yield_kg / Y_ctrl - 1))


    
  final_with_deltas <- final_with_deltas %>%
  dplyr::mutate(
    Practice      = dplyr::coalesce(Practice.x, Practice.y),
    Subpractice   = dplyr::coalesce(Subpractice.x, Subpractice.y),
    Magnitude_pct = dplyr::coalesce(Magnitude_pct.x, Magnitude_pct.y)
  ) %>%
  dplyr::select(
    B.Code, Control_Arm, A.Level.Name,
    Practice, Subpractice, Magnitude_pct,
    CH4_kg_year, Yield, Product, Units, P.Product,
    days_per_year, yield_kg, annual_yield_kg, EI_g_per_kg,
    EI_ctrl, CH4_ctrl, Y_ctrl,
    Delta_EI_pct, Delta_EI_g_per_kg, Delta_CH4_pct, Delta_Y_pct
  ) %>%
  dplyr::distinct()

# (optional) keep only treatment rows (i.e., exclude the control arm itself)
final_with_deltas <- final_with_deltas %>%
  dplyr::filter(A.Level.Name != Control_Arm)

  

```


```{r}
# ---- A) EI by Practice (treatments only; point overlay + median diamond) ----
ei_practice_df <- final_with_ei_all %>% filter(!Practice %in% c("Control","No change"))

ggplot(ei_practice_df, aes(x = Practice, y = EI_g_per_kg, fill = Practice)) +
  geom_boxplot(alpha = 0.6, outlier.alpha = 0.35) +
  stat_summary(fun = median, geom = "point",
               shape = 23, size = 2.8, fill = "white", color = "black") +
  geom_jitter(width = 0.15, alpha = 0.55, size = 1.4, show.legend = FALSE) +
  labs(x = NULL, y = expression("Emission intensity (g CH"[4]*"/ kg product)"),
       title = "Emission intensity by practice") +
  theme_minimal(12) + theme(legend.position = "none")

# ---- B) ΔEI (%) by Practice (treatments vs control) ----
ggplot(final_with_deltas, aes(x = Practice, y = Delta_EI_pct, fill = Practice)) +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_boxplot(alpha = 0.6, outlier.alpha = 0.35) +
  stat_summary(fun = median, geom = "point",
               shape = 23, size = 2.6, fill = "white", color = "black") +
  geom_jitter(width = 0.15, alpha = 0.55, size = 1.3, show.legend = FALSE) +
  labs(x = NULL, y = "Δ Emission intensity (% vs control)",
       title = "Δ Emission intensity by practice") +
  theme_minimal(12) + theme(legend.position = "none")

```


```{r}
# ---- C) EI by Subpractice (with Ns in labels; reorder by median) ----
labs_sub <- final_with_ei_all %>%
  count(Subpractice, name = "n") %>%
  mutate(Subpractice_lab = paste0(Subpractice, " (n=", n, ")"))

plot_ei_sub <- final_with_ei_all %>%
  left_join(labs_sub, by = "Subpractice") %>%
  mutate(Subpractice_lab = fct_reorder(Subpractice_lab, EI_g_per_kg, median, na.rm = TRUE))

ggplot(plot_ei_sub,
       aes(x = Subpractice_lab, y = EI_g_per_kg, fill = Subpractice)) +
  geom_boxplot(alpha = 0.6, outlier.alpha = 0.35) +
  stat_summary(fun = median, geom = "point",
               shape = 23, size = 2.6, fill = "white", color = "black") +
  geom_jitter(width = 0.15, alpha = 0.55, size = 1.2, show.legend = FALSE) +
  coord_flip() +
  labs(x = NULL, y = expression("Emission intensity (g CH"[4]*"/ kg product)"),
       title = "Emission intensity by subpractice (dominant diet lever)") +
  theme_minimal(12) + theme(legend.position = "none")

# ---- D) ΔEI (%) by Subpractice (with points + median; Ns; reordered) ----
labs_sub_delta <- final_with_deltas %>%
  count(Subpractice, name = "n") %>%
  mutate(Subpractice_lab = paste0(Subpractice, " (n=", n, ")"))

plot_delta_sub <- final_with_deltas %>%
  left_join(labs_sub_delta, by = "Subpractice") %>%
  mutate(Subpractice_lab = fct_reorder(Subpractice_lab, Delta_EI_pct, median, na.rm = TRUE))

ggplot(plot_delta_sub,
       aes(x = Subpractice_lab, y = Delta_EI_pct, fill = Subpractice)) +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_boxplot(alpha = 0.6, outlier.alpha = 0.35) +
  stat_summary(fun = median, geom = "point",
               shape = 23, size = 2.6, fill = "white", color = "black") +
  geom_jitter(width = 0.15, height = 0, alpha = 0.55, size = 1.4, show.legend = FALSE) +
  coord_flip() +
  labs(x = NULL, y = "Δ Emission intensity (% vs control)",
       title = "Δ Emission intensity by subpractice (dominant diet lever)") +
  theme_minimal(12) + theme(legend.position = "none")

plot_delta_sub <- final_with_deltas %>%
  filter(Practice=="Addition")%>%
  left_join(labs_sub_delta, by = "Subpractice") %>%
  mutate(Subpractice_lab = fct_reorder(Subpractice_lab, Delta_EI_pct, median, na.rm = TRUE))

ggplot(plot_delta_sub,
       aes(x = Subpractice_lab, y = Delta_EI_pct, fill = Subpractice)) +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_boxplot(alpha = 0.6, outlier.alpha = 0.35) +
  stat_summary(fun = median, geom = "point",
               shape = 23, size = 2.6, fill = "white", color = "black") +
  geom_jitter(width = 0.15, height = 0, alpha = 0.55, size = 1.4, show.legend = FALSE) +
  coord_flip() +
  labs(x = NULL, y = "Δ Emission intensity (% vs control)",
       title = "Δ Emission intensity by subpractice (dominant diet lever)") +
  theme_minimal(12) + theme(legend.position = "none")


ggplot(plot_delta_sub,
       aes(x = Subpractice_lab, y = Delta_Y_pct, fill = Subpractice)) +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_boxplot(alpha = 0.6, outlier.alpha = 0.35) +
  stat_summary(fun = median, geom = "point",
               shape = 23, size = 2.6, fill = "white", color = "black") +
  geom_jitter(width = 0.15, height = 0, alpha = 0.55, size = 1.4, show.legend = FALSE) +
  coord_flip() +
  labs(x = NULL, y = "Δ yield intensity (% vs control)",
       title = "Δ yield  by subpractice (dominant diet lever)") +
  theme_minimal(12) + theme(legend.position = "none")

```
### 18.2) Plot the data
```{r}

# Filter meat yield data and drop missing values
yield_meat <- yield_with_emissions %>%
  filter(Out.Subind == "Meat Yield") %>%
  filter(!is.na(ED.Mean.T) & !is.na(CH4_kg_year) & !is.na(P.Product))

# Get axis limits
x_range <- range(yield_meat$ED.Mean.T, na.rm = TRUE)
y_range <- range(yield_meat$CH4_kg_year, na.rm = TRUE)

# Plot
ggplot(yield_meat, aes(x = ED.Mean.T, y = CH4_kg_year, color = P.Product)) +
  geom_point(alpha = 0.8, size = 2.5) +
  scale_x_log10(
    limits = x_range,
    breaks = scales::log_breaks(n = 5),
    labels = scales::comma_format()
  ) +
  scale_y_continuous(
    limits = y_range,
    labels = scales::comma_format()
  ) +
  labs(
    title = "CH4 Emissions vs. Meat Yield",
    x = "Meat Yield per Individual (kg)",
    y = "Annual CH4 Emissions (kg)",
    color = "Livestock Species"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

```{r}
# Filter meat yield data and drop missing values
yield_milk <- yield_with_emissions %>%
  filter(Out.Subind == "Milk Yield") %>%
  filter(!is.na(ED.Mean.T) & !is.na(CH4_kg_year) & !is.na(P.Product))

# Get axis limits
x_range <- range(yield_milk$ED.Mean.T, na.rm = TRUE)
y_range <- range(yield_milk$CH4_kg_year, na.rm = TRUE)

# Plot
ggplot(yield_milk, aes(x = ED.Mean.T, y = CH4_kg_year, color = P.Product)) +
  geom_point(alpha = 0.8, size = 2.5) +
  scale_x_log10(
    limits = x_range,
    breaks = scales::log_breaks(n = 5),
    labels = scales::comma_format()
  ) +
  scale_y_continuous(
    limits = y_range,
    labels = scales::comma_format()
  ) +
  labs(
    title = "CH4 Emissions vs. Milk Yield",
    x = "Milk Yield per Individual (kg)",
    y = "Annual CH4 Emissions (kg)",
    color = "Livestock Species"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")

```


```{r}
# Filter and clean data
emissions_by_species <- yield_with_emissions %>%
  filter(!is.na(CH4_kg_year), !is.na(P.Product))

# Boxplot with transparent points
ggplot(emissions_by_species, aes(x = P.Product, y = CH4_kg_year, fill = P.Product)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.4) +  # lighter fill and no outliers
  geom_jitter(width = 0.2, alpha = 0.5, color = "black", size = 2) +  # transparent points
  labs(
    title = "Annual CH4 Emissions by Livestock Species",
    x = "Species",
    y = "Annual CH4 Emissions (kg)"
  ) +
  theme_minimal() +
  theme(legend.position = "none")  # remove redundant legend

```


```{r}
# Filter and clean data for Goat and Sheep only
emissions_by_species <- yield_with_emissions %>%
  filter(!is.na(CH4_kg_year), P.Product %in% c("Goat", "Sheep"))

# Boxplot with transparent points for Goat and Sheep
ggplot(emissions_by_species, aes(x = P.Product, y = CH4_kg_year, fill = P.Product)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.4) +
  geom_jitter(width = 0.2, alpha = 0.5, color = "black", size = 2) +
  labs(
    title = "Annual CH4 Emissions: Goat vs. Sheep",
    x = "Species",
    y = "Annual CH4 Emissions (kg)"
  ) +
  theme_minimal() +
  theme(legend.position = "none")

```




```{r}
##############################################
##  1.  PREPARE DAILY YIELD (kg animal-1 d-1)
##############################################

## density of milk for L → kg conversion
MILK_DENSITY <- 1.03   # kg L-1

yield_d_clean <- yield_data %>%                      # ← your harmonised table
  filter(Out.Subind %in% c("Milk Yield", "Meat Yield")) %>%
  mutate(
    Yield_kg_day = case_when(
      # ───────────── Milk ─────────────────────────────────────────────
      Out.Subind == "Milk Yield" & Out.Unit == "l/individual/day"  ~ ED.Mean.T * MILK_DENSITY,
      Out.Subind == "Milk Yield" & Out.Unit == "kg/individual/day" ~ ED.Mean.T,
      
      # ───────────── Meat (already kg day-1) ─────────────────────────
      Out.Subind == "Meat Yield" & Out.Unit == "kg/individual/day" ~ ED.Mean.T,
      
      # ───────────── Everything else (drop) ─────────────────────────
      TRUE ~ NA_real_
    )
  ) %>%
  filter(!is.na(Yield_kg_day) & Yield_kg_day > 0) %>%   # keep usable rows only
  select(B.Code, A.Level.Name, Out.Subind, Yield_kg_day)


###########################################################################
##  2.  COMPUTE EMISSION-INTENSITY  (kg CH4 per kg *product*) #############
###########################################################################

ei_prod <- GE_combined %>%                              # absolute CH4 table
  select(B.Code, A.Level.Name = D.Item,
         CH4_kg_year, P.Product,T.Control) %>%
  inner_join(yield_d_clean, by = c("B.Code","A.Level.Name")) %>%
  mutate(
    Yield_kg_year = Yield_kg_day * 365,
    EI_CH4_prod   = CH4_kg_year / Yield_kg_year,
    Product       = if_else(Out.Subind == "Milk Yield", "Milk", "Meat")
  ) %>%
  filter(EI_CH4_prod > 0, EI_CH4_prod < 10)             # drop negatives / crazy outliers

#########################################
##  3.  QUICK DIAGNOSTIC PLOTS ##########
#########################################

# ── A) Box-and-jitter by species & product ───────────────────────────────
ggplot(ei_prod, aes(x = P.Product, y = EI_CH4_prod,
                    fill = P.Product)) +
  geom_boxplot(outlier.shape = NA, alpha = .35) +
  geom_jitter(width = .15, alpha = .65, size = 2) +
  scale_y_log10("Emission-intensity (kg CH₄ kg⁻¹ product)",
                breaks = scales::log_breaks(),
                labels = scales::comma_format()) +
  facet_wrap(~ Product, nrow = 1) +
  labs(title = "Enteric-methane intensity of milk and meat production",
       x = NULL) +
  theme_minimal(base_size = 13) +
  theme(legend.position = "none")


```

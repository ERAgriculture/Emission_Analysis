---
title: "9_Emission_Identify_Practices"
output: html_document
date: "2025-09-26"
---

```{r}
diet_percentages <- read.csv("~/Emission_Analysis/data/diet_percentages_classif.csv")
total_amounts <- read.csv("~/Emission_Analysis/data/total_amounts.csv")
classif_ing_simple <- read.csv("~/Emission_Analysis/data/classif_ing_simple.csv")
merged_metadata <- readRDS("~/Emission_Analysis/data/merged_metadata_nutrition_inference.rds")
GE_combined<-read.csv("~/Emission_Analysis/data/GE_combined.csv")
classif_diet<-read.csv("~/Emission_Analysis/data/classif_diet.csv")

ctrl_key <- merged_metadata$MT.Out[, .(
  B.Code,
  A.Level.Name,
  T.Name,
  T.Control
)]

ctrl_key <- ctrl_key %>%
  inner_join(
    diet_percentages %>% distinct(B.Code, A.Level.Name),
    by = c("B.Code", "A.Level.Name")
  )


#clear names

roman_to_name <- function(x) dplyr::recode(
  x,
  "I"   = "High-starch",
  "II"  = "High-fat",
  "III" = "Protein",
  "IV"  = "Good forage",
  "V"   = "Poor forage",
  "VI"  = "Mineral/Vitamin",
  .default = x,
  .missing = NA_character_
)

# Update the ingredient database
classif_ing_simple <- classif_ing_simple %>%
  dplyr::mutate(
    Ingredient_Category = roman_to_name(Ingredient_Category))
    # If you also keep a diet-level tag, uncomment:
    # , Diet_Category = roman_to_name(Diet_Category)
  
```

### 19 practice ingredient comparison 

```{r}
suppressPackageStartupMessages({
  library(dplyr); library(tidyr); library(stringr); library(purrr)
})

classify_diet_practice <- function(
  diet_percentages,
  total_amounts,
  ctrl_key,
  classif_ing_simple,
  TOTAL_TOL = 0.05,
  ING_TOL   = 1.0,
  BAL_TOL   = 3.0
){
  ensure_col <- function(df, col, fill = NA_character_) {
    if (!col %in% names(df)) df[[col]] <- fill
    df
  }
  norm_item <- function(x){
    x %>% stringr::str_to_lower() %>%
      stringr::str_replace_all("[[:space:]]+", " ") %>%
      stringr::str_trim()
  }

  # ---- Ingredient lookup ----
  ing_lu <- classif_ing_simple %>%
    transmute(D.Item_norm = norm_item(D.Item),
              Ingredient_Category_lu = Ingredient_Category) %>%
    filter(!is.na(D.Item_norm), D.Item_norm != "") %>%
    group_by(D.Item_norm) %>%
    summarise(Ingredient_Category_lu = dplyr::first(na.omit(Ingredient_Category_lu)),
              .groups = "drop")

  # ---- Control per study ----
  ctrl_lu <- ctrl_key %>%
    filter(tolower(T.Control) == "yes") %>%
    arrange(B.Code, A.Level.Name) %>%
    group_by(B.Code) %>%
    summarise(Control = first(A.Level.Name), .groups = "drop")

  # ---- Totals (kg) ----
  totals_kg <- total_amounts %>%
    mutate(Total_kg = case_when(
      D.Unit.Amount == "g"  ~ Total_Amount/1000,
      D.Unit.Amount == "kg" ~ Total_Amount,
      TRUE ~ NA_real_
    )) %>%
    group_by(B.Code, A.Level.Name) %>%
    summarise(Total_kg = sum(Total_kg, na.rm = TRUE), .groups = "drop")

  # ---- Percentages + category fill ----
  dp <- ensure_col(diet_percentages, "Ingredient_Category")

  pct_long <- dp %>%
    select(B.Code, A.Level.Name, D.Item, Percentage_of_Diet, Ingredient_Category) %>%
    group_by(B.Code, A.Level.Name, D.Item, Ingredient_Category) %>%
    summarise(Percentage_of_Diet = sum(Percentage_of_Diet, na.rm = TRUE), .groups = "drop") %>%
    mutate(D.Item_norm = norm_item(D.Item)) %>%
    left_join(ing_lu, by = "D.Item_norm") %>%
    mutate(Ingredient_Category = coalesce(Ingredient_Category, Ingredient_Category_lu, "Unclassified")) %>%
    select(-D.Item_norm, -Ingredient_Category_lu)

  # ---- Pairs ----
  pairs <- pct_long %>%
    distinct(B.Code, A.Level.Name) %>%
    inner_join(ctrl_lu, by = "B.Code") %>%
    filter(A.Level.Name != Control) %>%
    transmute(B.Code, Control, Trt = A.Level.Name) %>%
    distinct()

  trt_tbl <- pct_long %>%
    rename(Trt = A.Level.Name, p_trt = Percentage_of_Diet) %>%
    select(B.Code, Trt, D.Item, Ingredient_Category, p_trt)

  ctrl_tbl <- pct_long %>%
    rename(Control = A.Level.Name, p_ctrl = Percentage_of_Diet) %>%
    select(B.Code, Control, D.Item, p_ctrl)

  trt_vs_ctrl <- pairs %>%
    left_join(trt_tbl,  by = c("B.Code","Trt")) %>%
    left_join(ctrl_tbl, by = c("B.Code","Control","D.Item")) %>%
    mutate(
      p_trt  = coalesce(p_trt,  0),
      p_ctrl = coalesce(p_ctrl, 0),
      dP     = p_trt - p_ctrl,
      dir    = case_when(
        dP >=  ING_TOL ~ "increase",
        dP <= -ING_TOL ~ "decrease",
        TRUE           ~ "nochange"
      )
    )

  delta_totals <- pairs %>%
    left_join(totals_kg %>% rename(Total_trt_kg  = Total_kg),
              by = c("B.Code","Trt" = "A.Level.Name")) %>%
    left_join(totals_kg %>% rename(Total_ctrl_kg = Total_kg),
              by = c("B.Code","Control" = "A.Level.Name")) %>%
    mutate(ŒîTOTAL = (Total_trt_kg - Total_ctrl_kg)/Total_ctrl_kg)

  top_changes <- trt_vs_ctrl %>%
    group_by(B.Code, Control, Trt) %>%
    arrange(desc(abs(dP)), .by_group = TRUE) %>%
    summarise(
      Top_changes = paste(
        head(sprintf("%s %s%.1f%%", D.Item, if_else(dP>=0,"+",""), dP), 3),
        collapse = "; "
      ),
      .groups = "drop"
    )

  summarize_types <- function(x) paste(sort(unique(na.omit(x))), collapse = ", ")

  paired <- trt_vs_ctrl %>%
    left_join(delta_totals %>% select(B.Code, Trt, ŒîTOTAL), by = c("B.Code","Trt")) %>%
    group_by(B.Code, Control, Trt, ŒîTOTAL) %>%
    summarise(
      POS_sum   = sum(pmax(dP,0),  na.rm = TRUE),
      NEG_sum   = sum(pmax(-dP,0), na.rm = TRUE),
      n_pos     = sum(dir=="increase",  na.rm = TRUE),
      n_neg     = sum(dir=="decrease",  na.rm = TRUE),
      Types_added     = summarize_types(Ingredient_Category[dir=="increase"]),
      Types_decreased = summarize_types(Ingredient_Category[dir=="decrease"]),
      .groups = "drop"
    ) %>%
    left_join(top_changes, by = c("B.Code","Control","Trt")) %>%
    mutate(
      Practice = case_when(
        is.finite(ŒîTOTAL) & abs(ŒîTOTAL) >  TOTAL_TOL & POS_sum >= ING_TOL ~ "Addition",
        is.finite(ŒîTOTAL) & abs(ŒîTOTAL) <= TOTAL_TOL &
          POS_sum >= ING_TOL & NEG_sum >= ING_TOL &
          abs(POS_sum - NEG_sum) <= BAL_TOL                               ~ "Substitution",
        is.finite(ŒîTOTAL) & abs(ŒîTOTAL) <= TOTAL_TOL &
          POS_sum >= ING_TOL & NEG_sum <  ING_TOL                         ~ "Addition",
        (POS_sum + NEG_sum) < ING_TOL                                     ~ "No change",
        TRUE                                                               ~ "Substitution"
      ),
      Magnitude_pct = case_when(
        Practice == "Addition"     ~ POS_sum,
        Practice == "Substitution" ~ 0.5*(POS_sum + NEG_sum),
        TRUE                       ~ 0
      )
    ) %>%
    rowwise() %>%
    mutate(
      Substitution_pairs = {
        if (Practice != "Substitution") {
          ""
        } else {
          b <- B.Code; t <- Trt
          pos_type <- trt_vs_ctrl %>%
            filter(B.Code == b, Trt == t) %>%
            group_by(Ingredient_Category) %>%
            summarise(pos = sum(pmax(dP,0),  na.rm=TRUE), .groups="drop") %>%
            filter(pos > 0) %>% arrange(desc(pos))
          neg_type <- trt_vs_ctrl %>%
            filter(B.Code == b, Trt == t) %>%
            group_by(Ingredient_Category) %>%
            summarise(neg = sum(pmax(-dP,0), na.rm=TRUE), .groups="drop") %>%
            filter(neg > 0) %>% arrange(desc(neg))
          np <- min(nrow(pos_type), nrow(neg_type))
          if (np == 0) "" else
            paste(paste0(neg_type$Ingredient_Category[seq_len(np)],
                         " ‚Üí ",
                         pos_type$Ingredient_Category[seq_len(np)]),
                  collapse="; ")
        }
      }
    ) %>%
    ungroup() %>%
    # NEW: add Subpractice but KEEP the detailed columns
    mutate(
      Subpractice = dplyr::case_when(
        Practice == "Addition"     ~ Types_added,
        Practice == "Substitution" ~ Substitution_pairs,
        TRUE                       ~ ""
      )
    ) %>%
    select(
      B.Code, Control, Trt,
      Practice, Subpractice, Magnitude_pct,
      ŒîTOTAL, POS_sum, NEG_sum, n_pos, n_neg,
      Types_added, Types_decreased, Substitution_pairs, Top_changes
    ) %>%
    arrange(B.Code, Control, Trt)

  paired
}

# Run
practice_tbl <- classify_diet_practice(
  diet_percentages   = diet_percentages,
  total_amounts      = total_amounts,
  ctrl_key           = ctrl_key,
  classif_ing_simple = classif_ing_simple,
  TOTAL_TOL = 0.05, ING_TOL = 1.0, BAL_TOL = 3.0
)

```



```{r}
suppressPackageStartupMessages({
  library(dplyr); library(stringr); library(tidyr); library(purrr)
})

# --- Rebuild the same control lookup used in the function ---
ctrl_lu <- ctrl_key %>%
  filter(tolower(T.Control) == "yes") %>%
  arrange(B.Code, A.Level.Name) %>%
  group_by(B.Code) %>%
  summarise(Control = first(A.Level.Name), .groups = "drop")

# --- Diet coverage per paper (from the raw diet_percentages you feed the function) ---
diets_per_code <- diet_percentages %>%
  filter(!is.na(B.Code), !is.na(A.Level.Name)) %>%
  group_by(B.Code) %>%
  summarise(
    n_diets = n_distinct(A.Level.Name),
    n_rows  = n(),                     # total ingredient rows for those diets
    .groups = "drop"
  )

# --- Candidates that *should* be classifiable: have a control & at least 2 diets ---
candidates <- diets_per_code %>%
  left_join(ctrl_lu %>% mutate(has_control = TRUE), by = "B.Code") %>%
  mutate(has_control = coalesce(has_control, FALSE)) %>%
  mutate(eligible = has_control & n_diets >= 2)

# --- B.Codes that actually produced a practice row ---
in_practice <- practice_tbl %>% distinct(B.Code)

# --- 1) Papers that could not be classified at all (no rows in practice_tbl) ---
unclassified_papers <- candidates %>%
  mutate(in_practice = B.Code %in% in_practice$B.Code) %>%
  filter(!in_practice | !eligible) %>%         # either not produced, or not eligible
  transmute(
    B.Code,
    n_diets,
    has_control,
    reason = case_when(
      !has_control                    ~ "No control diet flagged in ctrl_key",
      n_diets < 2                     ~ "Only one diet available (need ‚â• 2)",
      has_control & n_diets >= 2 & !in_practice ~ "Pairing failed (no Trt vs Control built)",
      TRUE                            ~ "Other/unknown"
    )
  ) %>%
  arrange(desc(has_control), desc(n_diets), B.Code)

# --- 2) Papers that *were* classified, but every comparison is "No change" ---
no_change_papers <- practice_tbl %>%
  group_by(B.Code) %>%
  summarise(
    n_pairs         = n(),                         # number of Trt vs Control pairs
    n_no_change     = sum(Practice == "No change"),
    all_no_change   = n_pairs > 0 & n_no_change == n_pairs,
    .groups = "drop"
  ) %>%
  filter(all_no_change) %>%
  arrange(desc(n_pairs))

# (Optional) attach product/species to both tables
prod_lu <- merged_metadata$`Prod.Out` %>%
  distinct(B.Code, P.Product)

unclassified_papers <- unclassified_papers %>%
  left_join(prod_lu, by = "B.Code") %>%
  relocate(P.Product, .after = B.Code)

no_change_papers <- no_change_papers %>%
  left_join(prod_lu, by = "B.Code") %>%
  relocate(P.Product, .after = B.Code)

# --- Quick summaries you can show in a slide ---
summary_unclassified <- unclassified_papers %>%
  count(reason, name = "n_papers") %>%
  arrange(desc(n_papers))

summary_no_change_by_prod <- no_change_papers %>%
  count(P.Product, name = "n_papers_all_no_change")

# Peek
unclassified_papers %>% head(10)
no_change_papers %>% head(10)
summary_unclassified
summary_no_change_by_prod

```
 ## comparing trt to trt as well 
```{r}
# --- Libraries ---------------------------------------------------------------
suppressPackageStartupMessages({
  library(dplyr); library(stringr); library(tidyr); library(purrr)
})

# --- Control key --------------------------------------------------------------
ctrl_key <- merged_metadata$MT.Out[, .(
  B.Code,
  A.Level.Name,
  T.Name,
  T.Control
)] %>%
  inner_join(
    diet_percentages %>% distinct(B.Code, A.Level.Name),
    by = c("B.Code", "A.Level.Name")
  )

# --- Roman ‚Üí friendly names ---------------------------------------------------
roman_to_name <- function(x) dplyr::recode(
  x,
  "I"   = "High-starch",
  "II"  = "High-fat",
  "III" = "Protein",
  "IV"  = "Good forage",
  "V"   = "Poor forage",
  "VI"  = "Mineral/Vitamin",
  .default = x,
  .missing = NA_character_
)

classif_ing_simple <- classif_ing_simple %>%
  mutate(Ingredient_Category = roman_to_name(Ingredient_Category))

# --- Pairwise classifier ------------------------------------------------------
classify_diet_practice_pairwise <- function(
  diet_percentages,
  ctrl_key,
  classif_ing_simple,
  ING_TOL   = 1.0,   # min category change to count
  MAG_TOL   = 5.0,   # total movement threshold for relevance
  BAL_RATIO = 1.5,   # dominance ratio (add vs reduce)
  BAL_TOL   = 3.0    # tolerance for balanced substitution
){
  # --- Helpers ----------------------------------------------------------------
  ensure_col <- function(df, col, fill = NA_character_) {
    if (!col %in% names(df)) df[[col]] <- fill
    df
  }
  norm_item <- function(x){
    x %>% stringr::str_to_lower() %>%
      stringr::str_replace_all("[[:space:]]+", " ") %>%
      stringr::str_trim()
  }
  summarize_types <- function(x) paste(sort(unique(na.omit(x))), collapse = ", ")

  # --- Ingredient lookup ------------------------------------------------------
  ing_lu <- classif_ing_simple %>%
    transmute(D.Item_norm = norm_item(D.Item),
              Ingredient_Category_lu = Ingredient_Category) %>%
    filter(!is.na(D.Item_norm), D.Item_norm != "") %>%
    group_by(D.Item_norm) %>%
    summarise(Ingredient_Category_lu = first(na.omit(Ingredient_Category_lu)),
              .groups = "drop")

  # --- Control lookup ---------------------------------------------------------
  ctrl_lu <- ctrl_key %>%
    filter(tolower(T.Control) == "yes") %>%
    arrange(B.Code, A.Level.Name) %>%
    group_by(B.Code) %>%
    summarise(Control = first(A.Level.Name), .groups = "drop")

  # --- Prepare diet-level composition ----------------------------------------
  dp <- ensure_col(diet_percentages, "Ingredient_Category")

  pct_long <- dp %>%
    select(B.Code, A.Level.Name, D.Item, Percentage_of_Diet, Ingredient_Category) %>%
    mutate(D.Item_norm = norm_item(D.Item)) %>%
    left_join(ing_lu, by = "D.Item_norm") %>%
    mutate(Ingredient_Category = coalesce(Ingredient_Category, Ingredient_Category_lu, "Unclassified")) %>%
    group_by(B.Code, A.Level.Name, Ingredient_Category, D.Item) %>%
    summarise(Item_pct = sum(Percentage_of_Diet, na.rm = TRUE), .groups = "drop")

  # --- Ordered pairs (row order) ---------------------------------------------
  arms <- pct_long %>%
    distinct(B.Code, A.Level.Name) %>%
    group_by(B.Code) %>%
    mutate(diet_order = row_number()) %>%
    ungroup()

  pairs_all <- arms %>%
    rename(A = A.Level.Name, order_A = diet_order) %>%
    inner_join(arms %>% rename(B = A.Level.Name, order_B = diet_order),
               by = "B.Code") %>%
    filter(order_A < order_B) %>%
    select(B.Code, A, B) %>%
    left_join(ctrl_lu, by = "B.Code") %>%
    mutate(pair_type = if_else(!is.na(Control) & (A == Control | B == Control),
                               "trt_vs_ctrl", "trt_vs_trt"))

  # --- Compute ŒîP per ingredient ---------------------------------------------
  ingredient_list <- pct_long %>% distinct(B.Code, D.Item, Ingredient_Category)

  A_tbl <- pct_long %>% rename(A = A.Level.Name, p_A = Item_pct)
  B_tbl <- pct_long %>% rename(B = A.Level.Name, p_B = Item_pct)

  A_vs_B <- pairs_all %>%
    left_join(ingredient_list, by = "B.Code") %>%
    left_join(A_tbl, by = c("B.Code", "A", "D.Item", "Ingredient_Category")) %>%
    left_join(B_tbl, by = c("B.Code", "B", "D.Item", "Ingredient_Category")) %>%
    mutate(
      p_A = coalesce(p_A, 0),
      p_B = coalesce(p_B, 0),
      dP  = p_B - p_A,
      dir = case_when(
        dP >=  ING_TOL ~ "increase",
        dP <= -ING_TOL ~ "decrease",
        TRUE           ~ "nochange"
      )
    )

  # --- Presence/absence changes ----------------------------------------------
  presence <- A_vs_B %>%
    group_by(B.Code, A, B) %>%
    summarise(
      added_items    = list(D.Item[p_A == 0 & p_B > 0]),
      removed_items  = list(D.Item[p_A > 0 & p_B == 0]),
      Types_added     = summarize_types(Ingredient_Category[p_A == 0 & p_B > 0]),
      Types_decreased = summarize_types(Ingredient_Category[p_A > 0 & p_B == 0]),
      .groups = "drop"
    )

  # --- Aggregate magnitude stats ---------------------------------------------
  paired <- A_vs_B %>%
    group_by(B.Code, A, B) %>%
    summarise(
      POS_sum = sum(pmax(dP, 0), na.rm = TRUE),
      NEG_sum = sum(pmax(-dP, 0), na.rm = TRUE),
      Magnitude_pct = sum(abs(dP), na.rm = TRUE),
      .groups = "drop"
    ) %>%
    left_join(presence, by = c("B.Code", "A", "B")) %>%
    mutate(
      added_n   = lengths(added_items),
      removed_n = lengths(removed_items)
    )

  # --- Classify practice type -------------------------------------------------
  paired <- paired %>%
    mutate(
      Practice = case_when(
        added_n > 0 & removed_n == 0 ~ "Addition",
        removed_n > 0 & added_n == 0 ~ "Reduction",
        added_n > 0 & removed_n > 0  ~ "Substitution",
        Magnitude_pct < MAG_TOL ~ "No change",
        POS_sum > NEG_sum * BAL_RATIO ~ "Addition",
        NEG_sum > POS_sum * BAL_RATIO ~ "Reduction",
        abs(POS_sum - NEG_sum) <= BAL_TOL ~ "Substitution",
        TRUE ~ "No change"
      )
    )

  # --- Generate substitution pairs (presence-based or magnitude-based) -------
  paired <- paired %>%
    rowwise() %>%
    mutate(
      Substitution_pairs = {
        if (Practice != "Substitution") {
          ""
        } else if (added_n > 0 & removed_n > 0) {
          paste0(Types_decreased, " ‚Üí ", Types_added)
        } else {
          bc <- B.Code; a <- A; b <- B
          pos_types <- A_vs_B %>%
            filter(B.Code == bc, A == a, B == b, dP >= ING_TOL) %>%
            distinct(Ingredient_Category)
          neg_types <- A_vs_B %>%
            filter(B.Code == bc, A == a, B == b, dP <= -ING_TOL) %>%
            distinct(Ingredient_Category)
          np <- min(nrow(pos_types), nrow(neg_types))
          if (np == 0) "" else
            paste(
              paste0(neg_types$Ingredient_Category[seq_len(np)],
                     " ‚Üí ",
                     pos_types$Ingredient_Category[seq_len(np)]),
              collapse = "; "
            )
        }
      },
      Subpractice = case_when(
        Practice == "Addition"     ~ Types_added,
        Practice == "Reduction"    ~ Types_decreased,
        Practice == "Substitution" ~ Substitution_pairs,
        TRUE ~ ""
      )
    ) %>%
    ungroup()

  # --- Reorient Reductions as Additions --------------------------------------
  paired <- paired %>%
    mutate(original_Practice = Practice) %>%
    mutate(flip = (original_Practice == "Reduction")) %>%
    mutate(
      A_new = if_else(flip, B, A),
      B_new = if_else(flip, A, B),
      POS_sum_new = if_else(flip, NEG_sum, POS_sum),
      NEG_sum_new = if_else(flip, POS_sum, NEG_sum),
      Types_added_new = if_else(flip, Types_decreased, Types_added),
      Types_decreased_new = if_else(flip, Types_added, Types_decreased),
      Subpractice_new = if_else(flip, Types_added_new, Subpractice),
      Practice_new = if_else(flip, "Addition", Practice)
    ) %>%
    mutate(
      A = A_new,
      B = B_new,
      POS_sum = POS_sum_new,
      NEG_sum = NEG_sum_new,
      Types_added = Types_added_new,
      Types_decreased = Types_decreased_new,
      Subpractice = Subpractice_new,
      Practice = Practice_new
    ) %>%
    select(-ends_with("_new"), -flip, -original_Practice)

  # --- Final tidy table ------------------------------------------------------
  out <- paired %>%
    left_join(pairs_all %>% select(B.Code, A, B, pair_type),
              by = c("B.Code","A","B")) %>%
    select(
      B.Code, pair_type, A, B,
      Practice, Subpractice, Magnitude_pct,
      POS_sum, NEG_sum, added_n, removed_n,
      Types_added, Types_decreased, Substitution_pairs
    ) %>%
    arrange(B.Code, pair_type, A, B)

  out
}

# --- Run ---------------------------------------------------------------------
practice_pairwise_tbl <- classify_diet_practice_pairwise(
  diet_percentages   = diet_percentages,
  ctrl_key           = ctrl_key,
  classif_ing_simple = classif_ing_simple,
  ING_TOL = 1.0, MAG_TOL = 5.0, BAL_RATIO = 1.5, BAL_TOL = 3.0
)


```
 



## diet clasffication practice 
```{r}
suppressPackageStartupMessages({
  library(dplyr); library(tidyr); library(stringr)
})

# --- Roman ‚Üí full name (keeps non-Roman as-is) -----------------------------
roman_to_name <- function(x) dplyr::recode(
  x,
  "I"  = "High-starch",
  "II" = "High-fat",
  "III"= "Protein",
  "IV" = "Good forage",
  "V"  = "Poor forage",
  "VI" = "Mineral/Vitamin",
  .default = x, .missing = NA_character_
)

# --- Normalise item names to improve join hit-rate -------------------------
norm_item <- function(x){
  x %>%
    stringr::str_to_lower() %>%
    stringr::str_replace_all("[[:space:]]+", " ") %>%
    stringr::str_trim() %>%
    # a couple of handy harmonisations seen in your data:
    stringr::str_replace("^unspecified\\s+molasses$", "molasses") %>%
    stringr::str_replace_all("\\bbran\\b", "offal")
}

# --- 1) Ingredient lookup (D.Item -> Ingredient_Category) ------------------
stopifnot(all(c("D.Item","Ingredient_Category") %in% names(classif_ing_simple)))

ing_lu <- classif_ing_simple %>%
  transmute(
    D.Item_norm = norm_item(D.Item),
    Cat_ing = roman_to_name(Ingredient_Category)
  ) %>%
  filter(!is.na(D.Item_norm), D.Item_norm != "") %>%
  group_by(D.Item_norm) %>%
  summarise(Cat_ing = first(na.omit(Cat_ing)), .groups = "drop")

# --- 2) Per-arm diet category = top-contributing ingredient type ----------
# expects: diet_percentages has B.Code, A.Level.Name, D.Item, Percentage_of_Diet
stopifnot(all(c("B.Code","A.Level.Name","D.Item","Percentage_of_Diet") %in% names(diet_percentages)))

arm_cat <- diet_percentages %>%
  mutate(
    D.Item_norm = norm_item(D.Item),
    Percentage_of_Diet = coalesce(Percentage_of_Diet, 0)
  ) %>%
  left_join(ing_lu, by = "D.Item_norm") %>%
  # sum % by ingredient *category* within each arm
  group_by(B.Code, A.Level.Name, Cat_ing) %>%
  summarise(pct_cat = sum(Percentage_of_Diet, na.rm = TRUE), .groups = "drop") %>%
  # pick the max category per arm (ties broken deterministically)
  group_by(B.Code, A.Level.Name) %>%
  arrange(desc(pct_cat), Cat_ing, .by_group = TRUE) %>%
  slice(1) %>%
  ungroup() %>%
  transmute(
    B.Code, A.Level.Name,
    Diet_Category = if_else(is.na(Cat_ing) | Cat_ing == "", "Unknown", Cat_ing)
  )

diet_cat_lu <- distinct(arm_cat)

# (optional) quick diagnostic
# table(diet_cat_lu$Diet_Category, useNA = "ifany")

# --- 3) Control ‚Üí Treatment switches (simple) ------------------------------
# ctrl_key must have B.Code, A.Level.Name, T.Control (TRUE/"yes" marks control)
stopifnot(all(c("B.Code","A.Level.Name","T.Control") %in% names(ctrl_key)))

ctrl_lu <- ctrl_key %>%
  filter(T.Control== "yes") %>%
  arrange(B.Code, A.Level.Name) %>%
  group_by(B.Code) %>%
  summarise(Control = first(A.Level.Name), .groups = "drop")

pairs <- diet_cat_lu %>%
  distinct(B.Code, A.Level.Name) %>%
  inner_join(ctrl_lu, by = "B.Code") %>%
  filter(A.Level.Name != Control) %>%
  transmute(B.Code, Control, Trt = A.Level.Name)

ctl <- diet_cat_lu %>% transmute(B.Code, Control = A.Level.Name, Cat_ctrl = Diet_Category)
trt <- diet_cat_lu %>% transmute(B.Code, Trt     = A.Level.Name, Cat_trt  = Diet_Category)

diet_switches <- pairs %>%
  left_join(ctl, by = c("B.Code","Control")) %>%
  left_join(trt, by = c("B.Code","Trt")) %>%
  mutate(
    Cat_ctrl = ifelse(is.na(Cat_ctrl) | Cat_ctrl=="", "Unknown", Cat_ctrl),
    Cat_trt  = ifelse(is.na(Cat_trt)  | Cat_trt=="",  "Unknown", Cat_trt),
    Switch   = paste0(Cat_ctrl, " \u2192 ", Cat_trt),
    Practice_simple = dplyr::case_when(
      Cat_ctrl == "Unknown" | Cat_trt == "Unknown" ~ "Unknown",
      Cat_ctrl == Cat_trt                          ~ "Same category",
      TRUE                                         ~ "Category switch"
    )
  ) %>%
  arrange(B.Code, Control, Trt)

# counts + transition table
switch_counts <- diet_switches %>%
  count(Cat_ctrl, Cat_trt, name = "n") %>%
  arrange(desc(n))

transition_table <- switch_counts %>%
  tidyr::pivot_wider(names_from = Cat_trt, values_from = n, values_fill = 0) %>%
  arrange(Cat_ctrl)

# --- Results ready to use ---------------------------------------------------
# diet_switches    # one row per trt vs control with Switch text
# switch_counts    # tall counts of Cat_ctrl -> Cat_trt
# transition_table # wide matrix of transitions


```

## count diet paper and GE

```{r}
library(dplyr)
library(stringr)

# --- 1) CH4 availability per (B.Code, D.Item) --------------------------------
ch4_avail <- GE_combined %>%
  mutate(
    has_ch4 = !is.na(CH4_kg_year) | tolower(CH4_flag) == "yes"
  ) %>%
  # If there are multiple rows per (B.Code, D.Item), keep the one showing CH4 if any
  group_by(B.Code, D.Item) %>%
  summarise(
    P.Product = dplyr::first(na.omit(P.Product)),
    has_ch4   = any(has_ch4, na.rm = TRUE),
    .groups = "drop"
  )

# --- 2) Join CH4 to idet_switches for control and treatment -------------------
sw <- diet_switches %>%
  # define category switch robustly from your columns
  mutate(category_switch = !is.na(Cat_ctrl) & !is.na(Cat_trt) & Cat_ctrl != Cat_trt) %>%
  # control side
  left_join(
    ch4_avail %>% rename(P.Product_ctrl = P.Product,
                         has_ch4_ctrl   = has_ch4),
    by = c("B.Code", "Control" = "D.Item")
  ) %>%
  # treatment side
  left_join(
    ch4_avail %>% rename(P.Product_trt = P.Product,
                         has_ch4_trt   = has_ch4),
    by = c("B.Code", "Trt" = "D.Item")
  ) %>%
  # pick a single product label (prefer when both match; otherwise coalesce)
  mutate(
    same_product = !is.na(P.Product_ctrl) & !is.na(P.Product_trt) & P.Product_ctrl == P.Product_trt,
    P.Product = case_when(
      same_product ~ P.Product_ctrl,
      TRUE ~ coalesce(P.Product_ctrl, P.Product_trt)
    )
  )

# --- 3) Keep rows with category switch AND CH4 on both sides ------------------
sw_ok <- sw %>%
  filter(
    category_switch |
      (is.character(Practice_simple) & tolower(Practice_simple) == "category switch")
  ) %>%
  filter(has_ch4_ctrl %in% TRUE, has_ch4_trt %in% TRUE)

# --- 4a) Count: For how many papers per product (animal)? ---------------------
# "paper" == unique B.Code
per_product_counts <- sw_ok %>%
  distinct(B.Code, P.Product) %>%
  count(P.Product, name = "n_papers_with_switch_and_both_CH4") %>%
  arrange(desc(n_papers_with_switch_and_both_CH4), P.Product)

# --- 4b) Detailed rows to *show the data* ------------------------------------
details <- sw_ok %>%
  transmute(
    B.Code,
    P.Product,
    Control, Trt,
    Cat_ctrl, Cat_trt,
    Switch = ifelse(!is.na(Switch), Switch,
                    paste0(Cat_ctrl, " \u2192 ", Cat_trt)),
    CH4_ctrl_available = has_ch4_ctrl,
    CH4_trt_available  = has_ch4_trt
  ) %>%
  arrange(P.Product, B.Code, Control, Trt)

# --- 4c) Overall total across all products (optional) -------------------------
total_papers_any_product <- n_distinct(details$B.Code)

# Quick looks
print(per_product_counts)
cat("Total unique papers with a category switch and CH4 for both arms:", total_papers_any_product, "\n")
print(details, n = 50)

```
## diet classification practice 

```{r}


suppressPackageStartupMessages({
  library(dplyr)
  library(tidyr)
  library(stringr)
  library(purrr)
})

# --- 1) Clean and prepare both datasets -------------------------------------
classif_diet_clean <- classif_diet %>%
  mutate(
    A.Level.Name = str_squish(str_to_lower(D.Item)),
    M7_Category  = str_squish(M7_Category)
  ) %>%
  select(B.Code, A.Level.Name, M7_Category) %>%
  distinct()

diet_meta <- merged_metadata$Animals.Diet %>%
  mutate(
    A.Level.Name = str_squish(str_to_lower(A.Level.Name))
  ) %>%
  distinct(B.Code, A.Level.Name)

# --- 2) Merge classification onto metadata ----------------------------------
diet_final <- diet_meta %>%
  left_join(classif_diet_clean, by = c("B.Code", "A.Level.Name")) %>%
  mutate(M7_Category = coalesce(M7_Category, "Unclassified"))

# --- 3) Generate all possible pairs within each B.Code ----------------------
diet_pairs <- diet_final %>%
  group_by(B.Code) %>%
  summarise(all_arms = list(A.Level.Name), .groups = "drop") %>%
  filter(lengths(all_arms) >= 2) %>%       # <‚Äî filter out single-diet codes
  mutate(pairs = map(all_arms, ~ t(combn(.x, 2)) %>% as.data.frame())) %>%
  unnest(pairs) %>%
  rename(A = V1, B = V2)

# --- 4) Attach category info for each diet in the pair ----------------------
pairwise_diets <- diet_pairs %>%
  left_join(diet_final %>% rename(Diet_A = M7_Category), by = c("B.Code", "A" = "A.Level.Name")) %>%
  left_join(diet_final %>% rename(Diet_B = M7_Category), by = c("B.Code", "B" = "A.Level.Name")) %>%
  mutate(
    Practice = if_else(Diet_A != Diet_B, "Diet shift", "No change"),
    Subpractice = if_else(Diet_A != Diet_B, paste0(Diet_A, " ‚Üí ", Diet_B), "")
  )

# --- 5) Final clean output ---------------------------------------------------
pairwise_diet_shift_tbl <- pairwise_diets %>%
  select(B.Code, A, B, Practice, Subpractice, Diet_A, Diet_B) %>%
  arrange(B.Code, A, B)




```

```{r}
write.csv(practice_tbl,"data/practice_tbl.csv")
write.csv(practice_pairwise_tbl,"data/practice_trt_tbl.csv")
write.csv(pairwise_diet_shift_tbl,"data/pairwise_diet_shift_tbl.csv")



```


## number of papers
```{r}


# --- Reload key processed tables --------------------------------------------
ingredients      <- read.csv("~/Emission_Analysis/data/ingredients_classified.csv")
classif_diet      <- read.csv("~/Emission_Analysis/data/classif_diet.csv")
GE_combined       <- read.csv("~/Emission_Analysis/data/GE_combined.csv")
practice_tbl      <- read.csv("data/practice_tbl.csv")
pairwise_diet_shift_tbl <- read.csv("data/pairwise_diet_shift_tbl.csv")

# --- 1Ô∏è‚É£ Identify papers with valid CH‚ÇÑ emissions ----------------------------
ge_with_ch4 <- GE_combined %>%
  filter(!is.na(CH4_kg_year)) %>%
  group_by(B.Code, P.Product) %>%
  summarise(has_CH4 = any(!is.na(CH4_kg_year)), .groups = "drop") %>%
  filter(has_CH4) %>%
  distinct(B.Code, P.Product)

# --- 2Ô∏è‚É£ Ingredient completeness by paper ------------------------------------
ing_status <- ingredients %>%
  group_by(B.Code) %>%
  summarise(
    n_ing = n(),
    n_ing_classified = sum(!is.na(Ingredient_Category)),
    all_ing_classified = n_ing > 0 & (n_ing_classified == n_ing),
    .groups = "drop"
  )

# --- 3Ô∏è‚É£ Diet classification coverage ----------------------------------------
diet_status <- classif_diet %>%
  group_by(B.Code) %>%
  summarise(
    n_diets_classified = sum(!is.na(M7_Category)),
    has_any_classified = n_diets_classified > 0,
    .groups = "drop"
  )

# --- 4Ô∏è‚É£ Papers with at least one ingredient-level practice ------------------
paper_with_practice <- practice_tbl %>%
  distinct(B.Code) %>%
  mutate(has_practice = TRUE)

# --- 5Ô∏è‚É£ Papers with at least one diet shift (pairwise) ----------------------
paper_with_diet_shift <- pairwise_diet_shift_tbl %>%
  filter(Practice == "Diet shift") %>%
  distinct(B.Code) %>%
  mutate(has_diet_shift = TRUE)

# --- 6Ô∏è‚É£ Merge all metadata together -----------------------------------------
meta <- ge_with_ch4 %>%
  mutate(has_CH4 = TRUE) %>%     # üëà add this line
  left_join(ing_status,              by = "B.Code") %>%
  left_join(diet_status,             by = "B.Code") %>%
  left_join(paper_with_practice,     by = "B.Code") %>%
  left_join(paper_with_diet_shift,   by = "B.Code") %>%
  mutate(
    has_practice       = coalesce(has_practice, FALSE),
    has_diet_shift     = coalesce(has_diet_shift, FALSE),
    all_ing_classified = coalesce(all_ing_classified, FALSE),
    has_any_classified = coalesce(has_any_classified, FALSE)
  )


# --- 7Ô∏è‚É£ Filter combinations of interest -------------------------------------
# 7a. Ingredient-level: emissions + all ingredients classified + ‚â•1 practice
ing_practice_emiss <- meta %>%
  filter(has_CH4, all_ing_classified, has_practice)

# 7b. Diet-level: emissions + at least 1 classified diet + ‚â•1 diet shift
diet_shift_emiss <- meta %>%
  filter(has_CH4, has_any_classified, has_diet_shift)

# --- 8Ô∏è‚É£ Summarise by product/species ----------------------------------------
summary_by_species <- full_join(
  ing_practice_emiss %>%
    count(P.Product, name = "N_Papers_Ingredients_Practice"),
  diet_shift_emiss %>%
    count(P.Product, name = "N_Papers_DietShift"),
  by = "P.Product"
) %>%
  mutate(across(starts_with("N_"), ~ replace_na(., 0))) %>%
  arrange(P.Product)

# --- 9Ô∏è‚É£ Display -------------------------------------------------------------
knitr::kable(
  summary_by_species,
  caption = "Papers with emissions and classification completeness, by product"
)

cat("Total papers with ingredient practices + CH‚ÇÑ:", 
    n_distinct(ing_practice_emiss$B.Code), "\n")
cat("Total papers with diet shifts + CH‚ÇÑ:", 
    n_distinct(diet_shift_emiss$B.Code), "\n")




```


---
title: "4_Emission_ingredient_perc"
output: html_document
date: "2025-09-26"
---

```{r}
ingredients <- read.csv("C:/Users/mlolita/OneDrive - CGIAR/Alliance - ClimateActionNetZero - 1_Projects/G227-A1712_SAAF/2_Technical & Data/Lolita Emissions Paper/Emission_Analysis/data/ingredients_harmonized_subset.rds")
feed_intake <- read.csv("C:/Users/mlolita/OneDrive - CGIAR/Alliance - ClimateActionNetZero - 1_Projects/G227-A1712_SAAF/2_Technical & Data/Lolita Emissions Paper/Emission_Analysis/data/feed_intake_harmonized.csv")

```


## 10) Relative % of each ingredient in the diet

This table presents the relative percentage of each ingredient within a diet. To ensure accurate proportion calculations, we first filtered the dataset to include only diets with consistent units. Diets with incompatible or non-harmonizable units were excluded, as their proportions could not be reliably determined.

```{r,message=FALSE,warning=FALSE}
## 1. INGREDIENT-BASED TOTALS (ignoring ingredients with NA amount) ---------

# Drop ingredients with missing amount (treat as non-existing)
ingredients_nonmissing <- ingredients %>%
  filter(!is.na(D.Amount))

# Keep only diets where (non-missing) ingredients share a single unit
consistent_diets <- ingredients_nonmissing %>%
  group_by(B.Code, A.Level.Name) %>%
  mutate(Unit_Count = n_distinct(D.Unit.Amount)) %>%   # based only on non-missing rows
  filter(Unit_Count == 1) %>%                          # keep diets with a single unit
  ungroup()

# Sum ingredient amounts within each diet (all in the same unit)
total_ingr <- consistent_diets %>%
  group_by(B.Code, A.Level.Name, D.Unit.Amount) %>%
  summarise(
    Total_Amount_ingr = sum(D.Amount),
    .groups = "drop"
  )

## 2. WHOLE-DIET FEED-INTAKE TOTALS (absolute g/animal/day) -----------------

feed_intake_diet_g <- feed_intake %>%
  filter(is_entire_diet) %>%   # only full-diet rows
  mutate(
    Intake_Amount_g = case_when(
      Out.Unit.Amount == "kg" ~ ED.Mean.T * 1000,  # kg â†’ g
      Out.Unit.Amount == "g"  ~ ED.Mean.T,         # already g
      TRUE                    ~ NA_real_           # other units not handled here
    ),
    D.Unit.Amount = "g"        # unify intake-based totals to g
  ) %>%
  select(B.Code, A.Level.Name, D.Unit.Amount, Intake_Amount_g)

## 3. MERGE SOURCES AND FILTER TO ABSOLUTE MASS UNITS -----------------------

# we only trust totals in "g" or "kg" (absolute mass per animal/day)
valid_total_units <- c("g", "kg")

total_amounts <- feed_intake_diet_g %>%
  full_join(total_ingr,
            by = c("B.Code", "A.Level.Name", "D.Unit.Amount")) %>%
  mutate(
    # Prefer measured intake if available, otherwise ingredient sum
    Total_Amount = coalesce(Intake_Amount_g, Total_Amount_ingr)
  ) %>%
  select(B.Code, A.Level.Name, D.Unit.Amount, Total_Amount) %>%
  # keep only absolute mass units and positive totals
  filter(
    D.Unit.Amount %in% valid_total_units,
    !is.na(Total_Amount),
    Total_Amount > 0
  )

## 4. CHECK UNIT CORRESPONDENCE (ingredients vs totals) ---------------------

unit_check <- ingredients %>%
  select(B.Code, A.Level.Name, Ingredient_Unit = D.Unit.Amount) %>%
  distinct() %>%
  left_join(
    total_amounts %>%
      select(B.Code, A.Level.Name, Total_Unit = D.Unit.Amount),
    by = c("B.Code", "A.Level.Name")
  ) %>%
  mutate(Consistent_Units = Ingredient_Unit == Total_Unit)

# Keep only diets where ingredient units and total units match
consistent_unit_diets <- unit_check %>%
  filter(Consistent_Units) %>%
  select(B.Code, A.Level.Name)

# Ingredients used for % calculations:
#   - diet has consistent units
#   - D.Amount is non-missing (missing = not present)
ingredients_clean <- ingredients %>%
  semi_join(consistent_unit_diets, by = c("B.Code", "A.Level.Name")) %>%
  filter(!is.na(D.Amount))

totals_clean <- total_amounts %>%
  semi_join(consistent_unit_diets, by = c("B.Code", "A.Level.Name"))

## 5. PERCENTAGE CONTRIBUTION OF EACH INGREDIENT ----------------------------

diet_percentages <- ingredients_clean %>%
  left_join(
    totals_clean,
    by = c("B.Code", "A.Level.Name", "D.Unit.Amount")
  ) %>%
  mutate(
    Percentage_of_Diet = ifelse(
      Total_Amount > 0,
      (D.Amount / Total_Amount) * 100,
      NA_real_
    )
  ) %>%
  select(
    B.Code, A.Level.Name, D.Item, D.Type,
    D.Amount, D.Unit.Amount, Percentage_of_Diet
  )

# optional cleanup
rm(
  ingredients_nonmissing,
  consistent_diets,
  total_ingr,
  feed_intake_diet_g,
  unit_check,
  consistent_unit_diets,
  valid_total_units
)

```


```{r,message=FALSE,warning=FALSE}
# Check if each diet sums close to 100%
validation <- diet_percentages %>%
  group_by(B.Code, A.Level.Name) %>%
  summarise(Total_Percentage = sum(Percentage_of_Diet, na.rm=TRUE)) %>%
  ungroup()

# Display diets and their total percentages
# datatable(
#   validation, 
#   options = list(
#     pageLength = 10,         # Show 10 rows per page by default
#     scrollX = TRUE,          # Enable horizontal scrolling
#     autoWidth = TRUE,        # Adjust column width automatically
#     searchHighlight = TRUE   # Highlight search terms
#   ),
#   caption = "Validation table"
# )


```

The lines that have 0 as validation are the ones that were feeding ad libitum for which we do not have a precise amount so it's impossible to calculate the relative proportion of the ingredients.
```{r}
# Ensure folders exist
dir.create(file.path("data"), showWarnings = FALSE, recursive = TRUE)

# 1) merged metadata after all corrections
write.csv(diet_percentages,"C:/Users/mlolita/OneDrive - CGIAR/Alliance - ClimateActionNetZero - 1_Projects/G227-A1712_SAAF/2_Technical & Data/Lolita Emissions Paper/Emission_Analysis/data/diet_percentages.csv")
write.csv(total_amounts,"C:/Users/mlolita/OneDrive - CGIAR/Alliance - ClimateActionNetZero - 1_Projects/G227-A1712_SAAF/2_Technical & Data/Lolita Emissions Paper/Emission_Analysis/data/total_amounts.csv")


```


```{r}
## =============================================================================
## DIETARY IMPACT ON CH4 EMISSIONS AND PRODUCTIVITY
## Comparing Treatments vs Controls to Identify Climate-Smart Feeding Strategies
## 
## COMPLETE VERSION - Includes:
##   - Figure 1: CH4 Change Distribution
##   - Figure 2: Nutritional Drivers
##   - Figure 3A: Trade-off Analysis (Absolute CH4 vs Productivity)
##   - Figure 3B: Trade-off Analysis (Emission Intensity vs Productivity)
##   - Figure 4: Mitigation Summary
##   - Figure 5: Correlation Heatmap
## =============================================================================

# Load required packages
library(dplyr)
library(tidyr)
library(ggplot2)
library(stringr)
library(scales)
library(patchwork)
library(cowplot)

# Set theme
theme_set(theme_minimal(base_size = 12))

# Define color palette for categories
category_colors <- c(
  "Cattle - Dairy" = "#66C2A5",
  "Cattle - Meat" = "#FC8D62", 
  "Sheep" = "#8DA0CB",
  "Goat" = "#E78AC3"
)

# Quadrant colors for trade-off figures
quadrant_colors_ch4 <- c(
  "Win-Win" = "#2E7D32",
  "↓CH₄, ↓Yield" = "#1976D2",
  "↑CH₄, ↑Yield" = "#F57C00",
  "Lose-Lose" = "#C62828"
)

quadrant_colors_ei <- c(
  "Win-Win" = "#2E7D32",
  "↓Intensity, ↓Yield" = "#1976D2",
  "↑Intensity, ↑Yield" = "#F57C00",
  "Lose-Lose" = "#C62828"
)

# =============================================================================
# 1. LOAD DATA
# =============================================================================

cat("Loading data...\n")

master_ch4 <- read.csv("C:/Users/mlolita/OneDrive - CGIAR/Alliance - ClimateActionNetZero - 1_Projects/G227-A1712_SAAF/2_Technical & Data/Lolita Emissions Paper/Emission_Analysis/data/master_ch4.csv")
diet_nutrition <- read.csv("C:/Users/mlolita/OneDrive - CGIAR/Alliance - ClimateActionNetZero - 1_Projects/G227-A1712_SAAF/2_Technical & Data/Lolita Emissions Paper/Emission_Analysis/data/diet_nutriton.csv")
yield_with_emissions <- read.csv("C:/Users/mlolita/OneDrive - CGIAR/Alliance - ClimateActionNetZero - 1_Projects/G227-A1712_SAAF/2_Technical & Data/Lolita Emissions Paper/Emission_Analysis/data/yield_with_emissions.csv")

cat(paste0("Master CH4: ", nrow(master_ch4), " rows\n"))
cat(paste0("Diet nutrition: ", nrow(diet_nutrition), " rows\n"))
cat(paste0("Yield with emissions: ", nrow(yield_with_emissions), " rows\n"))

# =============================================================================
# 2. PREPARE DIET-LEVEL NUTRITION DATA
# =============================================================================

cat("\nPreparing nutrition data...\n")

diet_nutrients <- diet_nutrition %>%
  filter(is_entire_diet == TRUE) %>%
  mutate(value_pct = DC.Value / 10) %>%
  select(B.Code, D.Item, DC.Variable, value_pct) %>%
  pivot_wider(
    names_from = DC.Variable,
    values_from = value_pct,
    values_fn = mean
  ) %>%
  rename(Diet = D.Item)

# =============================================================================
# 3. MERGE NUTRITION WITH EMISSIONS DATA
# =============================================================================

cat("\nMerging data...\n")

analysis_data <- master_ch4 %>%
  filter(!is.na(CH4_g_d)) %>%
  filter(P.Product %in% c("Cattle", "Sheep", "Goat")) %>%
  left_join(diet_nutrients, by = c("B.Code", "Diet")) %>%
  mutate(
    Category = case_when(
      P.Product == "Cattle" & Purpose == "Dairy" ~ "Cattle - Dairy",
      P.Product == "Cattle" & Purpose == "Meat" ~ "Cattle - Meat",
      P.Product == "Sheep" ~ "Sheep",
      P.Product == "Goat" ~ "Goat",
      TRUE ~ "Other"
    )
  ) %>%
  filter(Category != "Other")

# =============================================================================
# 4. IDENTIFY CONTROL VS TREATMENT WITHIN STUDIES
# =============================================================================

cat("\nIdentifying control vs treatment groups...\n")

control_pattern <- "(?i)(control|con$|ctrl|basal|reference|t0|t1$|d0|d1$|standard|base|negative|0%|zero)"

analysis_data <- analysis_data %>%
  mutate(is_control = str_detect(Diet, control_pattern))

study_control_count <- analysis_data %>%
  group_by(B.Code, Category) %>%
  summarise(control_count = sum(is_control), .groups = "drop")

analysis_data <- analysis_data %>%
  left_join(study_control_count, by = c("B.Code", "Category")) %>%
  group_by(B.Code, Category) %>%
  mutate(
    row_num = row_number(),
    is_control = ifelse(control_count == 0 & row_num == 1, TRUE, is_control)
  ) %>%
  ungroup()

diet_counts <- analysis_data %>%
  group_by(B.Code, Category) %>%
  summarise(n_diets_in_study = n(), .groups = "drop")

analysis_data <- analysis_data %>%
  left_join(diet_counts, by = c("B.Code", "Category"))

study_comparisons <- analysis_data %>%
  filter(n_diets_in_study >= 2)

# =============================================================================
# 5. CALCULATE TREATMENT EFFECTS RELATIVE TO CONTROL
# =============================================================================

cat("\nCalculating treatment effects...\n")

control_values <- study_comparisons %>%
  filter(is_control) %>%
  group_by(B.Code, Category) %>%
  summarise(
    CH4_control = mean(CH4_g_d, na.rm = TRUE),
    DMI_control = mean(DMI_kg_d, na.rm = TRUE),
    CP_control = mean(CP, na.rm = TRUE),
    NDF_control = mean(NDF, na.rm = TRUE),
    EE_control = mean(EE, na.rm = TRUE),
    Forage_control = mean(For_percent, na.rm = TRUE),
    .groups = "drop"
  )

treatment_effects <- study_comparisons %>%
  left_join(control_values, by = c("B.Code", "Category")) %>%
  mutate(
    CH4_change_pct = ((CH4_g_d - CH4_control) / CH4_control) * 100,
    DMI_change_pct = ((DMI_kg_d - DMI_control) / DMI_control) * 100,
    CP_change = CP - CP_control,
    NDF_change = NDF - NDF_control,
    EE_change = EE - EE_control,
    Forage_change = For_percent - Forage_control
  ) %>%
  filter(!is_control)

# Set factor levels
treatment_effects$Category <- factor(treatment_effects$Category,
                                      levels = c("Cattle - Dairy", "Cattle - Meat", "Sheep", "Goat"))

cat(paste0("\nTreatment comparisons: ", nrow(treatment_effects), "\n"))

# =============================================================================
# 6. FIGURE 1: CH4 CHANGE DISTRIBUTION
# Cattle in left column, Small ruminants in right column
# =============================================================================

cat("\nCreating Figure 1: CH4 Change Distribution...\n")

# Calculate summary stats
change_summary <- treatment_effects %>%
  group_by(Category) %>%
  summarise(
    n = n(),
    n_papers = n_distinct(B.Code),
    mean_change = mean(CH4_change_pct, na.rm = TRUE),
    median_change = median(CH4_change_pct, na.rm = TRUE),
    pct_reduction = sum(CH4_change_pct < 0, na.rm = TRUE) / n() * 100,
    .groups = "drop"
  )

# Determine x-axis ranges for each column
cattle_data <- treatment_effects %>% 
  filter(Category %in% c("Cattle - Dairy", "Cattle - Meat"))
cattle_xlim <- c(
  min(cattle_data$CH4_change_pct, na.rm = TRUE) - 5,
  max(cattle_data$CH4_change_pct, na.rm = TRUE) + 5
)

small_rum_data <- treatment_effects %>% 
  filter(Category %in% c("Sheep", "Goat"))
small_rum_xlim <- c(
  min(small_rum_data$CH4_change_pct, na.rm = TRUE) - 5,
  min(max(small_rum_data$CH4_change_pct, na.rm = TRUE) + 5, 150)
)

# Create individual histogram plots
make_hist_plot <- function(data, cat, xlims, show_xlabel = FALSE) {
  summary_row <- change_summary %>% filter(Category == cat)
  
  p <- ggplot(data %>% filter(Category == cat), aes(x = CH4_change_pct)) +
    geom_histogram(bins = 25, fill = category_colors[cat], alpha = 0.7, color = "white") +
    geom_vline(xintercept = 0, linetype = "dashed", color = "red", linewidth = 1) +
    geom_vline(xintercept = summary_row$mean_change, linetype = "solid", color = "black", linewidth = 1) +
    annotate("text", x = Inf, y = Inf, 
             label = paste0("n=", summary_row$n, "; papers=", summary_row$n_papers,
                           "\nMean: ", round(summary_row$mean_change, 1), "%",
                           "\n", round(summary_row$pct_reduction, 0), "% reduction"),
             hjust = 1.05, vjust = 1.1, size = 3.2) +
    scale_x_continuous(limits = xlims) +
    labs(title = cat, y = "Count") +
    theme(
      plot.title = element_text(face = "bold", size = 11, hjust = 0.5),
      axis.title.x = element_blank(),
      panel.grid.minor = element_blank()
    )
  
  if (show_xlabel) {
    p <- p + labs(x = expression("Change in CH"[4]*" Emissions (%)"))
  }
  
  return(p)
}

p1_dairy <- make_hist_plot(treatment_effects, "Cattle - Dairy", cattle_xlim, FALSE)
p1_meat <- make_hist_plot(treatment_effects, "Cattle - Meat", cattle_xlim, TRUE)
p1_sheep <- make_hist_plot(treatment_effects, "Sheep", small_rum_xlim, FALSE)
p1_goat <- make_hist_plot(treatment_effects, "Goat", small_rum_xlim, TRUE)

fig1 <- (p1_dairy | p1_sheep) / (p1_meat | p1_goat) +
  plot_annotation(
    title = expression("Distribution of CH"[4]*" Emission Changes: Treatments vs Controls"),
    subtitle = "Red dashed = no change; Black solid = mean. Negative values indicate emission reductions.",
    theme = theme(
      plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
      plot.subtitle = element_text(size = 11, hjust = 0.5)
    )
  )

ggsave("C:/Users/mlolita/OneDrive - CGIAR/Alliance - ClimateActionNetZero - 1_Projects/G227-A1712_SAAF/2_Technical & Data/Lolita Emissions Paper/Emission_Analysis/figures/fig1_ch4_distribution.png", fig1, 
       width = 12, height = 9, dpi = 300, bg = "white")

# =============================================================================
# 7. FIGURE 2: NUTRITIONAL DRIVERS
# =============================================================================

cat("\nCreating Figure 2: Nutritional Drivers...\n")

nutrient_long <- treatment_effects %>%
  select(B.Code, Diet, Category, CH4_change_pct, 
         CP_change, NDF_change, EE_change, Forage_change) %>%
  pivot_longer(
    cols = c(CP_change, NDF_change, EE_change, Forage_change),
    names_to = "Nutrient",
    values_to = "Nutrient_change"
  ) %>%
  filter(!is.na(Nutrient_change), !is.na(CH4_change_pct)) %>%
  mutate(
    Nutrient = recode(
      Nutrient,
      "CP_change" = "Crude Protein",
      "NDF_change" = "NDF (Fiber)",
      "EE_change" = "Fat (EE)",
      "Forage_change" = "Forage"
    ),
    Nutrient = factor(Nutrient, levels = c("Crude Protein", "NDF (Fiber)", 
                                            "Fat (EE)", "Forage"))
  ) %>%
  filter(Nutrient_change < 101)

# Calculate correlations
correlations <- nutrient_long %>%
  group_by(Category, Nutrient) %>%
  filter(n() >= 5) %>%
  summarise(
    n = n(),
    r = cor(Nutrient_change, CH4_change_pct, use = "complete.obs"),
    p_value = tryCatch(
      cor.test(Nutrient_change, CH4_change_pct)$p.value,
      error = function(e) NA
    ),
    .groups = "drop"
  ) %>%
  mutate(
    sig = case_when(
      is.na(p_value) ~ "",
      p_value < 0.001 ~ "***",
      p_value < 0.01 ~ "**",
      p_value < 0.05 ~ "*",
      TRUE ~ ""
    ),
    label = paste0("r=", round(r, 2), sig, "\n(n=", n, ")")
  )

fig2 <- ggplot(nutrient_long, aes(x = Nutrient_change, y = CH4_change_pct)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50", alpha = 0.7) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray50", alpha = 0.7) +
  geom_point(aes(color = Category), alpha = 0.4, size = 1.5) +
  geom_smooth(method = "lm", se = TRUE, color = "black", linewidth = 0.8, alpha = 0.2) +
  facet_grid(Category ~ Nutrient, scales = "free_x") +
  geom_text(
    data = correlations,
    aes(x = Inf, y = Inf, label = label),
    hjust = 1.1, vjust = 1.2, size = 2.8, inherit.aes = FALSE
  ) +
  scale_color_manual(values = category_colors) +
  labs(
    title = expression("Nutritional Drivers of CH"[4]*" Emission Changes"),
    subtitle = "Each point = one treatment diet compared to its control. Correlation (r): positive = ↑nutrient → ↑CH₄",
    x = "Change in Nutrient Content (treatment - control, percentage points)",
    y = expression("Change in CH"[4]*" Emissions (%)")
  ) +
  theme(
    legend.position = "none",
    strip.text = element_text(face = "bold", size = 9),
    panel.grid.minor = element_blank(),
    axis.text = element_text(size = 8)
  )

ggsave("C:/Users/mlolita/OneDrive - CGIAR/Alliance - ClimateActionNetZero - 1_Projects/G227-A1712_SAAF/2_Technical & Data/Lolita Emissions Paper/Emission_Analysis/figures/fig2_nutrient_drivers.png", fig2, 
       width = 12, height = 10, dpi = 300, bg = "white")

# =============================================================================
# 8. PREPARE YIELD DATA FOR TRADE-OFF ANALYSIS
# =============================================================================

cat("\nPreparing yield data for trade-off analysis...\n")

yield_analysis <- yield_with_emissions %>%
  filter(!is.na(CH4_g_d), !is.na(ED.Mean.T)) %>%
  filter(P.Product %in% c("Cattle", "Sheep", "Goat")) %>%
  filter(Product %in% c("Milk", "Meat")) %>%
  mutate(
    Category = case_when(
      P.Product == "Cattle" & Product == "Milk" ~ "Cattle - Dairy",
      P.Product == "Cattle" & Product == "Meat" ~ "Cattle - Meat",
      P.Product == "Sheep" & Product == "Milk" ~ "Sheep - Dairy",
      P.Product == "Sheep" & Product == "Meat" ~ "Sheep - Meat",
      P.Product == "Goat" & Product == "Milk" ~ "Goat - Dairy",
      P.Product == "Goat" & Product == "Meat" ~ "Goat - Meat"
    ),
    Species = P.Product,
    # Calculate EMISSION INTENSITY (g CH4 / kg product)
    Emission_Intensity = CH4_g_d / ED.Mean.T
  ) %>%
  # Remove invalid intensity values
  filter(is.finite(Emission_Intensity), Emission_Intensity > 0)

# Identify controls in yield data
yield_analysis <- yield_analysis %>%
  mutate(is_control = str_detect(A.Level.Name, control_pattern))

yield_control_count <- yield_analysis %>%
  group_by(B.Code, Category) %>%
  summarise(control_count = sum(is_control), .groups = "drop")

yield_analysis <- yield_analysis %>%
  left_join(yield_control_count, by = c("B.Code", "Category")) %>%
  group_by(B.Code, Category) %>%
  mutate(
    row_num = row_number(),
    is_control = ifelse(control_count == 0 & row_num == 1, TRUE, is_control)
  ) %>%
  ungroup()

# Count diets per study
yield_diet_counts <- yield_analysis %>%
  group_by(B.Code, Category) %>%
  summarise(n_diets = n(), .groups = "drop")

yield_analysis <- yield_analysis %>%
  left_join(yield_diet_counts, by = c("B.Code", "Category")) %>%
  filter(n_diets >= 2)

# Calculate control values (including Emission Intensity)
yield_control_values <- yield_analysis %>%
  filter(is_control) %>%
  group_by(B.Code, Category, Product) %>%
  summarise(
    CH4_control = mean(CH4_g_d, na.rm = TRUE),
    Yield_control = mean(ED.Mean.T, na.rm = TRUE),
    EI_control = mean(Emission_Intensity, na.rm = TRUE),
    .groups = "drop"
  )

# Calculate treatment effects
yield_effects <- yield_analysis %>%
  left_join(yield_control_values, by = c("B.Code", "Category", "Product")) %>%
  mutate(
    CH4_change_pct = ((CH4_g_d - CH4_control) / CH4_control) * 100,
    Yield_change_pct = ((ED.Mean.T - Yield_control) / Yield_control) * 100,
    EI_change_pct = ((Emission_Intensity - EI_control) / EI_control) * 100
  ) %>%
  filter(!is_control) %>%
  filter(!is.na(CH4_change_pct), !is.na(Yield_change_pct), !is.na(EI_change_pct)) %>%
  # Remove extreme outliers
  filter(abs(CH4_change_pct) < 200, abs(Yield_change_pct) < 200, abs(EI_change_pct) < 200)

# Classify quadrants - ABSOLUTE CH4
yield_effects <- yield_effects %>%
  mutate(
    Quadrant_CH4 = case_when(
      CH4_change_pct <= 0 & Yield_change_pct >= 0 ~ "Win-Win",
      CH4_change_pct <= 0 & Yield_change_pct < 0 ~ "↓CH₄, ↓Yield",
      CH4_change_pct > 0 & Yield_change_pct >= 0 ~ "↑CH₄, ↑Yield",
      CH4_change_pct > 0 & Yield_change_pct < 0 ~ "Lose-Lose"
    ),
    Quadrant_CH4 = factor(Quadrant_CH4, levels = c("Win-Win", "↓CH₄, ↓Yield", 
                                                    "↑CH₄, ↑Yield", "Lose-Lose")),
    # Classify quadrants - EMISSION INTENSITY
    Quadrant_EI = case_when(
      EI_change_pct <= 0 & Yield_change_pct >= 0 ~ "Win-Win",
      EI_change_pct <= 0 & Yield_change_pct < 0 ~ "↓Intensity, ↓Yield",
      EI_change_pct > 0 & Yield_change_pct >= 0 ~ "↑Intensity, ↑Yield",
      EI_change_pct > 0 & Yield_change_pct < 0 ~ "Lose-Lose"
    ),
    Quadrant_EI = factor(Quadrant_EI, levels = c("Win-Win", "↓Intensity, ↓Yield", 
                                                  "↑Intensity, ↑Yield", "Lose-Lose"))
  )

cat(paste0("Yield comparisons: ", nrow(yield_effects), " from ", 
           n_distinct(yield_effects$B.Code), " papers\n"))

# =============================================================================
# 9. FIGURE 3A: ABSOLUTE CH4 TRADE-OFF
# =============================================================================

cat("\nCreating Figure 3A: Absolute CH4 Trade-off...\n")

# Summary statistics for CH4
yield_summary_ch4 <- yield_effects %>%
  group_by(Product, Species) %>%
  summarise(
    n = n(),
    n_papers = n_distinct(B.Code),
    win_win_pct = sum(Quadrant_CH4 == "Win-Win") / n() * 100,
    mean_ch4 = mean(CH4_change_pct, na.rm = TRUE),
    mean_yield = mean(Yield_change_pct, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(label = paste0("n=", n, "; papers=", n_papers, "\nWin-Win: ", round(win_win_pct, 0), "%"))

# Create MILK panel for CH4
milk_data <- yield_effects %>% filter(Product == "Milk")
milk_summary_ch4 <- yield_summary_ch4 %>% filter(Product == "Milk")

if (nrow(milk_data) > 0) {
  p3a_milk <- ggplot(milk_data, aes(x = Yield_change_pct, y = CH4_change_pct)) +
    annotate("rect", xmin = 0, xmax = Inf, ymin = -Inf, ymax = 0,
             fill = "lightgreen", alpha = 0.15) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "gray40", linewidth = 0.8) +
    geom_vline(xintercept = 0, linetype = "dashed", color = "gray40", linewidth = 0.8) +
    geom_point(aes(color = Quadrant_CH4, shape = Species), alpha = 0.7, size = 3) +
    scale_color_manual(values = quadrant_colors_ch4) +
    scale_shape_manual(values = c("Cattle" = 16, "Sheep" = 17, "Goat" = 15)) +
    geom_text(data = milk_summary_ch4, 
              aes(x = -Inf, y = Inf, label = label, group = Species),
              hjust = -0.05, vjust = 1.2, size = 2.8, inherit.aes = FALSE) +
    facet_wrap(~ Species, scales = "free") +
    labs(
      title = "MILK Production",
      x = "Change in Milk Yield (%)",
      y = expression("Change in CH"[4]*" (%)")
    ) +
    theme(
      legend.position = "none",
      strip.text = element_text(face = "bold"),
      plot.title = element_text(face = "bold", hjust = 0.5)
    )
} else {
  p3a_milk <- ggplot() + annotate("text", x = 0.5, y = 0.5, label = "No milk data") + theme_void()
}

# Create MEAT panel for CH4
meat_data <- yield_effects %>% filter(Product == "Meat")
meat_summary_ch4 <- yield_summary_ch4 %>% filter(Product == "Meat")

if (nrow(meat_data) > 0) {
  p3a_meat <- ggplot(meat_data, aes(x = Yield_change_pct, y = CH4_change_pct)) +
    annotate("rect", xmin = 0, xmax = Inf, ymin = -Inf, ymax = 0,
             fill = "lightgreen", alpha = 0.15) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "gray40", linewidth = 0.8) +
    geom_vline(xintercept = 0, linetype = "dashed", color = "gray40", linewidth = 0.8) +
    geom_point(aes(color = Quadrant_CH4, shape = Species), alpha = 0.7, size = 3) +
    scale_color_manual(values = quadrant_colors_ch4) +
    scale_shape_manual(values = c("Cattle" = 16, "Sheep" = 17, "Goat" = 15)) +
    geom_text(data = meat_summary_ch4,
              aes(x = -Inf, y = Inf, label = label, group = Species),
              hjust = -0.05, vjust = 1.2, size = 2.8, inherit.aes = FALSE) +
    facet_wrap(~ Species, scales = "free") +
    labs(
      title = "MEAT Production",
      x = "Change in Body Weight / Carcass Weight (%)",
      y = expression("Change in CH"[4]*" (%)")
    ) +
    theme(
      legend.position = "none",
      strip.text = element_text(face = "bold"),
      plot.title = element_text(face = "bold", hjust = 0.5)
    )
} else {
  p3a_meat <- ggplot() + annotate("text", x = 0.5, y = 0.5, label = "No meat data") + theme_void()
}

# Create legend for CH4
legend_data_ch4 <- data.frame(
  Quadrant = factor(c("Win-Win", "↓CH₄, ↓Yield", "↑CH₄, ↑Yield", "Lose-Lose"),
                    levels = c("Win-Win", "↓CH₄, ↓Yield", "↑CH₄, ↑Yield", "Lose-Lose"))
)
legend_plot_ch4 <- ggplot(legend_data_ch4, aes(x = 1, y = 1, color = Quadrant)) +
  geom_point(size = 5) +
  scale_color_manual(values = quadrant_colors_ch4,
                     labels = c("Win-Win (↓CH₄, ↑Yield)", 
                               "Trade-off (↓CH₄, ↓Yield)",
                               "Trade-off (↑CH₄, ↑Yield)",
                               "Lose-Lose (↑CH₄, ↓Yield)")) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 10)) +
  guides(color = guide_legend(nrow = 1))

legend_grob_ch4 <- get_legend(legend_plot_ch4)

# Combine panels for Figure 3A
fig3a <- (p3a_milk / p3a_meat) +
  plot_annotation(
    title = expression("Trade-offs: CH"[4]*" Emissions vs Productivity"),
    subtitle = "Green shaded area = Win-Win zone (reduced emissions AND increased productivity)",
    theme = theme(
      plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
      plot.subtitle = element_text(size = 11, hjust = 0.5)
    )
  )

fig3a_with_legend <- plot_grid(
  fig3a, legend_grob_ch4,
  ncol = 1, rel_heights = c(1, 0.08)
)

ggsave("C:/Users/mlolita/OneDrive - CGIAR/Alliance - ClimateActionNetZero - 1_Projects/G227-A1712_SAAF/2_Technical & Data/Lolita Emissions Paper/Emission_Analysis/data/figures/fig3a_ch4_tradeoff.png", fig3a_with_legend, 
       width = 14, height = 12, dpi = 300, bg = "white")

# =============================================================================
# 10. FIGURE 3B: EMISSION INTENSITY TRADE-OFF (SAME DESIGN)
# =============================================================================

cat("\nCreating Figure 3B: Emission Intensity Trade-off...\n")

# Summary statistics for EI
yield_summary_ei <- yield_effects %>%
  group_by(Product, Species) %>%
  summarise(
    n = n(),
    n_papers = n_distinct(B.Code),
    win_win_pct = sum(Quadrant_EI == "Win-Win") / n() * 100,
    mean_ei = mean(EI_change_pct, na.rm = TRUE),
    mean_yield = mean(Yield_change_pct, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(label = paste0("n=", n, "; papers=", n_papers, "\nWin-Win: ", round(win_win_pct, 0), "%"))

# Create MILK panel for EI
milk_summary_ei <- yield_summary_ei %>% filter(Product == "Milk")

if (nrow(milk_data) > 0) {
  p3b_milk <- ggplot(milk_data, aes(x = Yield_change_pct, y = EI_change_pct)) +
    annotate("rect", xmin = 0, xmax = Inf, ymin = -Inf, ymax = 0,
             fill = "lightgreen", alpha = 0.15) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "gray40", linewidth = 0.8) +
    geom_vline(xintercept = 0, linetype = "dashed", color = "gray40", linewidth = 0.8) +
    geom_point(aes(color = Quadrant_EI, shape = Species), alpha = 0.7, size = 3) +
    scale_color_manual(values = quadrant_colors_ei) +
    scale_shape_manual(values = c("Cattle" = 16, "Sheep" = 17, "Goat" = 15)) +
    geom_text(data = milk_summary_ei, 
              aes(x = -Inf, y = Inf, label = label, group = Species),
              hjust = -0.05, vjust = 1.2, size = 2.8, inherit.aes = FALSE) +
    facet_wrap(~ Species, scales = "free") +
    labs(
      title = "MILK Production",
      x = "Change in Milk Yield (%)",
      y = "Change in Emission Intensity (%)"
    ) +
    theme(
      legend.position = "none",
      strip.text = element_text(face = "bold"),
      plot.title = element_text(face = "bold", hjust = 0.5)
    )
} else {
  p3b_milk <- ggplot() + annotate("text", x = 0.5, y = 0.5, label = "No milk data") + theme_void()
}

# Create MEAT panel for EI
meat_summary_ei <- yield_summary_ei %>% filter(Product == "Meat")

if (nrow(meat_data) > 0) {
  p3b_meat <- ggplot(meat_data, aes(x = Yield_change_pct, y = EI_change_pct)) +
    annotate("rect", xmin = 0, xmax = Inf, ymin = -Inf, ymax = 0,
             fill = "lightgreen", alpha = 0.15) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "gray40", linewidth = 0.8) +
    geom_vline(xintercept = 0, linetype = "dashed", color = "gray40", linewidth = 0.8) +
    geom_point(aes(color = Quadrant_EI, shape = Species), alpha = 0.7, size = 3) +
    scale_color_manual(values = quadrant_colors_ei) +
    scale_shape_manual(values = c("Cattle" = 16, "Sheep" = 17, "Goat" = 15)) +
    geom_text(data = meat_summary_ei,
              aes(x = -Inf, y = Inf, label = label, group = Species),
              hjust = -0.05, vjust = 1.2, size = 2.8, inherit.aes = FALSE) +
    facet_wrap(~ Species, scales = "free") +
    labs(
      title = "MEAT Production",
      x = "Change in Body Weight / Carcass Weight (%)",
      y = "Change in Emission Intensity (%)"
    ) +
    theme(
      legend.position = "none",
      strip.text = element_text(face = "bold"),
      plot.title = element_text(face = "bold", hjust = 0.5)
    )
} else {
  p3b_meat <- ggplot() + annotate("text", x = 0.5, y = 0.5, label = "No meat data") + theme_void()
}

# Create legend for EI
legend_data_ei <- data.frame(
  Quadrant = factor(c("Win-Win", "↓Intensity, ↓Yield", "↑Intensity, ↑Yield", "Lose-Lose"),
                    levels = c("Win-Win", "↓Intensity, ↓Yield", "↑Intensity, ↑Yield", "Lose-Lose"))
)
legend_plot_ei <- ggplot(legend_data_ei, aes(x = 1, y = 1, color = Quadrant)) +
  geom_point(size = 5) +
  scale_color_manual(values = quadrant_colors_ei,
                     labels = c("Win-Win (↓Intensity, ↑Yield)", 
                               "Trade-off (↓Intensity, ↓Yield)",
                               "Trade-off (↑Intensity, ↑Yield)",
                               "Lose-Lose (↑Intensity, ↓Yield)")) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 10)) +
  guides(color = guide_legend(nrow = 1))

legend_grob_ei <- get_legend(legend_plot_ei)

# Combine panels for Figure 3B
fig3b <- (p3b_milk / p3b_meat) +
  plot_annotation(
    title = "Trade-offs: Emission Intensity vs Productivity",
    subtitle = "Green shaded area = Win-Win zone (reduced emission intensity AND increased productivity)",
    theme = theme(
      plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
      plot.subtitle = element_text(size = 11, hjust = 0.5)
    )
  )

fig3b_with_legend <- plot_grid(
  fig3b, legend_grob_ei,
  ncol = 1, rel_heights = c(1, 0.08)
)

ggsave("C:/Users/mlolita/OneDrive - CGIAR/Alliance - ClimateActionNetZero - 1_Projects/G227-A1712_SAAF/2_Technical & Data/Lolita Emissions Paper/Emission_Analysis/figures/fig3b_emission_intensity_tradeoff.png", fig3b_with_legend, 
       width = 14, height = 12, dpi = 300, bg = "white")

# =============================================================================
# 11. FIGURE 4: MITIGATION SUMMARY
# =============================================================================

cat("\nCreating Figure 4: Mitigation Summary...\n")

mitigation_summary <- treatment_effects %>%
  group_by(Category) %>%
  summarise(
    n = n(),
    n_papers = n_distinct(B.Code),
    mean_change = mean(CH4_change_pct, na.rm = TRUE),
    median_change = median(CH4_change_pct, na.rm = TRUE),
    pct_reduction = sum(CH4_change_pct < 0, na.rm = TRUE) / n() * 100,
    pct_10_reduction = sum(CH4_change_pct < -10, na.rm = TRUE) / n() * 100,
    pct_15_reduction = sum(CH4_change_pct < -15, na.rm = TRUE) / n() * 100,
    max_reduction = min(CH4_change_pct, na.rm = TRUE),
    .groups = "drop"
  )

# Panel A: Mean CH4 Change
p4a <- ggplot(mitigation_summary, aes(x = Category, y = mean_change, fill = Category)) +
  geom_col(alpha = 0.8, color = "black", width = 0.7) +
  geom_hline(yintercept = 0, linetype = "solid", color = "black") +
  geom_text(aes(label = paste0("n=", n)), vjust = -0.5, size = 3.5) +
  scale_fill_manual(values = category_colors) +
  labs(title = "A. Mean CH₄ Change", x = NULL, y = "Mean Change (%)") +
  theme(legend.position = "none", axis.text.x = element_text(angle = 45, hjust = 1))

# Panel B: % Showing Reduction
mitigation_long <- mitigation_summary %>%
  select(Category, pct_reduction, pct_10_reduction, pct_15_reduction) %>%
  pivot_longer(cols = -Category, names_to = "Threshold", values_to = "Percentage") %>%
  mutate(Threshold = recode(Threshold,
                            "pct_reduction" = "Any reduction",
                            "pct_10_reduction" = ">10% reduction",
                            "pct_15_reduction" = ">15% reduction"))

p4b <- ggplot(mitigation_long, aes(x = Category, y = Percentage, fill = Threshold)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7, alpha = 0.8, color = "black") +
  scale_fill_manual(values = c("Any reduction" = "#B3E5FC", 
                               ">10% reduction" = "#0288D1",
                               ">15% reduction" = "#01579B")) +
  labs(title = "B. % Showing Reduction", x = NULL, y = "% of Treatments", fill = NULL) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "top") +
  ylim(0, 55)

# Panel C: Distribution of Effects
p4c <- ggplot(treatment_effects, aes(x = Category, y = CH4_change_pct, fill = Category)) +
  geom_violin(alpha = 0.6, color = "black") +
  geom_boxplot(width = 0.15, fill = "white", outlier.size = 0.5) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red", linewidth = 1) +
  scale_fill_manual(values = category_colors) +
  labs(title = "C. Distribution of Effects", x = NULL, y = "CH₄ Change (%)") +
  theme(legend.position = "none", axis.text.x = element_text(angle = 45, hjust = 1)) +
  coord_cartesian(ylim = c(-60, 100))

fig4 <- p4a + p4b + p4c + 
  plot_layout(ncol = 3, widths = c(1, 1.3, 1)) +
  plot_annotation(
    title = expression("CH"[4]*" Mitigation Potential from Dietary Interventions"),
    theme = theme(plot.title = element_text(size = 14, face = "bold", hjust = 0.5))
  )

ggsave("C:/Users/mlolita/OneDrive - CGIAR/Alliance - ClimateActionNetZero - 1_Projects/G227-A1712_SAAF/2_Technical & Data/Lolita Emissions Paper/Emission_Analysis/figures/fig4_mitigation_summary.png", fig4, 
       width = 14, height = 5, dpi = 300, bg = "white")

# =============================================================================
# 12. FIGURE 5: CORRELATION HEATMAP
# =============================================================================

cat("\nCreating Figure 5: Correlation Heatmap...\n")

corr_matrix <- correlations %>%
  mutate(r_label = paste0(round(r, 2), sig)) %>%
  select(Category, Nutrient, r, r_label, p_value, sig)

fig5 <- ggplot(corr_matrix, aes(x = Nutrient, y = Category, fill = r)) +
  geom_tile(color = "white", linewidth = 1) +
  geom_text(aes(label = r_label), size = 5, fontface = "bold") +
  scale_fill_gradient2(
    low = "#1565C0", mid = "white", high = "#C62828",
    midpoint = 0, limits = c(-0.8, 0.9),
    name = "Correlation (r)"
  ) +
  labs(
    title = expression("Correlation Between Nutrient Changes and CH"[4]*" Changes"),
    subtitle = "* p<0.05, ** p<0.01, *** p<0.001 | Blue = mitigation (↑nutrient → ↓CH₄) | Red = increase",
    x = NULL, y = NULL
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 11, face = "bold"),
    axis.text.y = element_text(size = 11, face = "bold"),
    panel.grid = element_blank(),
    legend.position = "right"
  )

ggsave("C:/Users/mlolita/OneDrive - CGIAR/Alliance - ClimateActionNetZero - 1_Projects/G227-A1712_SAAF/2_Technical & Data/Lolita Emissions Paper/Emission_Analysis/figures/fig5_correlation_heatmap.png", fig5, 
       width = 10, height = 6, dpi = 300, bg = "white")

# =============================================================================
# 13. COMPREHENSIVE SUMMARY OUTPUT
# =============================================================================

cat("\n")
cat(strrep("=", 80), "\n")
cat("COMPREHENSIVE ANALYSIS SUMMARY\n")
cat(strrep("=", 80), "\n")

cat("\n### 1. DATA OVERVIEW ###\n")
cat(paste0("Total treatment-control comparisons: ", nrow(treatment_effects), "\n"))
cat(paste0("Total papers: ", n_distinct(treatment_effects$B.Code), "\n"))

cat("\n### 2. CH4 MITIGATION POTENTIAL BY CATEGORY ###\n")
print(mitigation_summary %>% 
        mutate(across(where(is.numeric), ~round(., 1))) %>%
        as.data.frame())

cat("\n### 3. TRADE-OFF COMPARISON: ABSOLUTE CH4 vs EMISSION INTENSITY ###\n")

# Compare win-win rates
comparison_table <- yield_effects %>%
  group_by(Product, Species) %>%
  summarise(
    n = n(),
    n_papers = n_distinct(B.Code),
    WinWin_CH4 = sum(Quadrant_CH4 == "Win-Win"),
    WinWin_CH4_pct = 100 * WinWin_CH4 / n,
    WinWin_EI = sum(Quadrant_EI == "Win-Win"),
    WinWin_EI_pct = 100 * WinWin_EI / n,
    Improvement_pp = WinWin_EI_pct - WinWin_CH4_pct,
    .groups = "drop"
  )

print(comparison_table %>% 
        mutate(across(where(is.numeric), ~round(., 1))) %>%
        as.data.frame())

cat("\n### 4. KEY INSIGHT: 'ORANGE DOTS' THAT BECOME WIN-WIN ###\n")
cat("(Cases where CH4↑ but Emission Intensity↓)\n")

for (prod in c("Milk", "Meat")) {
  prod_data <- yield_effects %>% filter(Product == prod)
  
  # Orange dots in CH4 analysis: ↑CH4, ↑Yield
  orange_dots <- prod_data %>% filter(CH4_change_pct > 0, Yield_change_pct > 0)
  
  # How many are Win-Win in EI analysis?
  intensity_wins <- orange_dots %>% filter(EI_change_pct < 0)
  
  cat(paste0("\n", prod, ":\n"))
  cat(paste0("  'Orange dots' (↑CH4, ↑Yield): ", nrow(orange_dots), "\n"))
  if (nrow(orange_dots) > 0) {
    cat(paste0("  Of which ↓Emission Intensity: ", nrow(intensity_wins), 
               " (", round(100*nrow(intensity_wins)/nrow(orange_dots), 0), "%)\n"))
  }
}

cat("\n### 5. SIGNIFICANT NUTRITIONAL DRIVERS (p < 0.05) ###\n")
sig_corr <- correlations %>%
  filter(!is.na(p_value) & p_value < 0.05) %>%
  arrange(r) %>%
  mutate(
    Direction = ifelse(r < 0, "MITIGATION (↑nutrient → ↓CH₄)", 
                       "INCREASE (↑nutrient → ↑CH₄)"),
    r = round(r, 2)
  ) %>%
  select(Category, Nutrient, r, Direction, n)

print(sig_corr %>% as.data.frame())

cat("\n### 6. KEY FINDINGS FOR PAPER ###\n")
cat(strrep("-", 60), "\n")

cat("\n**HEADLINE FINDING:**\n")
overall_reduction <- mean(treatment_effects$CH4_change_pct < 0, na.rm = TRUE) * 100
cat(paste0("Only ", round(overall_reduction, 0), 
           "% of dietary interventions reduce absolute CH₄ emissions\n"))

cat("\n**EMISSION INTENSITY REFRAMES THE STORY:**\n")
overall_ch4_ww <- 100 * sum(yield_effects$Quadrant_CH4 == "Win-Win") / nrow(yield_effects)
overall_ei_ww <- 100 * sum(yield_effects$Quadrant_EI == "Win-Win") / nrow(yield_effects)
cat(paste0("  • Absolute CH4 Win-Win: ", round(overall_ch4_ww, 0), "%\n"))
cat(paste0("  • Emission Intensity Win-Win: ", round(overall_ei_ww, 0), "%\n"))
cat(paste0("  • Improvement: +", round(overall_ei_ww - overall_ch4_ww, 0), " percentage points\n"))

cat("\n**BY SPECIES:**\n")
for (cat_name in levels(treatment_effects$Category)) {
  data <- treatment_effects %>% filter(Category == cat_name)
  ch4_data <- data$CH4_change_pct[!is.na(data$CH4_change_pct)]
  
  cat(paste0("\n", cat_name, ":\n"))
  cat(paste0("  - ", length(ch4_data), " comparisons from ", 
             n_distinct(data$B.Code), " papers\n"))
  cat(paste0("  - ", round(sum(ch4_data < 0)/length(ch4_data)*100, 0), 
             "% showed reduction\n"))
  cat(paste0("  - Mean: ", sprintf("%+.1f", mean(ch4_data)), 
             "%; Max reduction: ", round(min(ch4_data), 1), "%\n"))
}

cat("\n**POLICY IMPLICATION:**\n")
cat("  • Many interventions that increase absolute CH4 actually\n")
cat("    IMPROVE climate efficiency (lower emissions per kg product)\n")
cat("  • Focus on emission intensity, not just absolute emissions\n")
cat("  • Productivity-enhancing strategies often reduce emission intensity\n")

# =============================================================================
# 14. SAVE OUTPUTS
# =============================================================================

# write.csv(mitigation_summary, "summary_mitigation_potential.csv", row.names = FALSE)
# write.csv(correlations, "summary_nutrient_correlations.csv", row.names = FALSE)
# write.csv(yield_summary_ch4, "summary_yield_tradeoffs_ch4.csv", row.names = FALSE)
# write.csv(yield_summary_ei, "summary_yield_tradeoffs_ei.csv", row.names = FALSE)
# write.csv(comparison_table, "summary_ch4_vs_ei_comparison.csv", row.names = FALSE)

cat("\n")
cat(strrep("=", 80), "\n")
cat("Analysis complete! Figures saved:\n")
cat("  - fig1_ch4_distribution.png\n")
cat("  - fig2_nutrient_drivers.png\n")
cat("  - fig3a_ch4_tradeoff.png (Absolute CH4 vs Productivity)\n")
cat("  - fig3b_emission_intensity_tradeoff.png (Emission Intensity vs Productivity)\n")
cat("  - fig4_mitigation_summary.png\n")
cat("  - fig5_correlation_heatmap.png\n")
cat(strrep("=", 80), "\n")
```

